# WiFi 電子紙顯示器控制系統

**版本：** v1.4 (WiFi 雙模式版)  
**更新日期：** 2025-10-04

## 🎯 專案概述

這是一個結合 **WiFi 網頁控制** 和 **電子紙顯示** 的整合系統，可以透過手機或電腦的網頁介面輸入文字，並即時顯示在 4.26 吋電子紙螢幕上。

### ✨ 主要功能

- ✅ **WiFi 雙模式**：支援 AP 熱點模式 / Station 連線模式（編譯選項切換）
- ✅ **Station 模式**：連接到現有的 WiFi AP，取得 IP 位址
- ✅ **AP 熱點模式**：自動建立 WiFi 熱點供裝置連接
- ✅ **資訊顯示**：在電子紙左上角顯示 WiFi 連線資訊
- ✅ **文字輸入**：透過網頁 textbox 輸入文字
- ✅ **中央顯示**：輸入的文字顯示在電子紙中央區域
- ✅ **自動換行**：長文字自動換行顯示
- ✅ **即時更新**：修改文字後即時更新電子紙
- 🚀 **高速連線**：802.11n 模式，連線速度提升 178%
- 🚀 **快速載入**：PROGMEM + 分段傳輸，頁面載入減少 67%
- 🚀 **AJAX 更新**：文字更新速度提升 87%
- 🆕 **WebSocket 即時通訊**：雙向即時通訊，延遲降至 50ms
- 🆕 **進度顯示**：即時顯示更新進度（0% → 100%）
- 🆕 **多客戶端同步**：所有裝置即時同步更新
- 🆕 **自動重連**：斷線後 3 秒自動重新連線

## 📋 硬體需求

### 必要硬體
- **WeMos D1 Mini** (ESP8266) × 1
- **GDEQ0426T82** 4.26吋電子紙顯示器 × 1
- **杜邦線** × 8條
- **3.3kΩ 電阻** × 1 (CS 腳位下拉)
- **1kΩ 電阻** × 1 (RST 腳位上拉，建議)

### 硬體規格
- **電子紙**：800×480 像素黑白顯示
- **處理器**：ESP8266 @ 80MHz
- **記憶體**：~80KB 可用 RAM
- **通訊**：SPI + WiFi

## 🔌 硬體連接

```
WeMos D1 Mini    →    GDEQ0426T82         電阻
─────────────────     ─────────────       ─────────────
3.3V             →    VCC                 
GND              →    GND                 
D5 (GPIO14/SCK)  →    CLK                 
D7 (GPIO13/MOSI) →    DIN                 
D1 (GPIO5)       →    RST                 1kΩ 上拉到 3.3V
D3 (GPIO0)       →    DC                  
D8 (GPIO15)      →    CS                  3.3kΩ 下拉到 GND
D2 (GPIO4)       →    BUSY                
```

### ⚠️ 重要提醒
1. **電壓**：電子紙只能接 3.3V，不可接 5V
2. **CS 電阻**：D8 (GPIO15) 必須加 3.3kΩ 下拉電阻
3. **RST 電阻**：D1 (GPIO5) 建議加 1kΩ 上拉電阻

## 💻 軟體設定

### Arduino IDE 設定
1. **開發板**：ESP8266 Boards → WeMos D1 R1 & Mini
2. **Upload Speed**：921600 (或 115200)
3. **CPU Frequency**：80 MHz
4. **Flash Size**：4MB (FS:2MB OTA:~1019KB)

### 必要函式庫
```
1. GxEPD2 (by Jean-Marc Zingg)
2. Adafruit GFX Library
3. ESP8266WiFi (內建)
4. ESP8266WebServer (內建)
5. WebSockets (by Markus Sattler) v2.7.1+ ⭐ v1.3 新增
```

**安裝 WebSockets 函式庫：**
```
Arduino IDE → 工具 → 管理程式庫 → 搜尋 "WebSockets"
安裝 "WebSockets by Markus Sattler"
```

## 🚀 使用方式

### 1. 上傳程式
1. 將程式上傳到 WeMos D1 Mini
2. 打開序列埠監控視窗（115200 baud）
3. 等待系統初始化完成

### 2. 連接 WiFi

#### 🔹 Station 模式（預設）
系統會自動連接到指定的 WiFi AP：
1. 電子紙顯示「Connected: [SSID]」和取得的 IP
2. 在同一 WiFi 網路下，使用瀏覽器輸入顯示的 IP 位址
3. 例如：`http://192.168.1.100`

#### 🔹 AP 模式
如果要使用熱點模式，請先編輯程式碼（見下方「切換 WiFi 模式」）：
1. 在手機或電腦的 WiFi 設定中尋找熱點
2. 連接到：
   - **SSID**：`EPaper_Display`
   - **密碼**：`12345678`
3. 開啟瀏覽器，輸入：`http://192.168.4.1`

### 3. 開啟網頁控制介面
1. 開啟瀏覽器
2. 輸入電子紙上顯示的 IP 位址
3. 進入控制頁面

### 4. 輸入文字並顯示
1. 在文字框中輸入要顯示的內容
2. 按下「📤 更新顯示」按鈕
3. 觀察進度條：0% → 50% → 100% ⭐ v1.3 新增
4. 等待 2-3 秒，電子紙會更新顯示

## 🔄 切換 WiFi 模式 (v1.4 新增)

在 `wifi_display.ino` 的第 42 行，使用編譯選項切換模式：

### 使用 Station 模式（預設）
```cpp
#define USE_WIFI_STATION  // 連接到現有 WiFi AP
```
- 修改第 166-167 行設定你的 WiFi 帳號密碼：
```cpp
const char* wifi_ssid = "你的WiFi名稱";
const char* wifi_password = "你的WiFi密碼";
```

### 使用 AP 模式
```cpp
// #define USE_WIFI_STATION  // 註解掉此行
```
- 修改第 169-170 行設定熱點帳號密碼：
```cpp
const char* ap_ssid = "EPaper_Display";
const char* ap_password = "12345678";
```

## 📱 網頁介面功能

### v1.4 新增功能 🆕
- **雙模式支援**：網頁自動顯示對應的 WiFi 資訊
  - Station 模式：顯示連接的 SSID、IP、信號強度
  - AP 模式：顯示熱點 SSID、密碼、IP

### v1.3 新增功能
- **WebSocket 狀態**：即時顯示連線狀態（🟢 已連線 / 🔴 已斷線）
- **進度條**：顯示電子紙更新進度（0% → 100%）
- **即時同步**：多個裝置同時開啟，一個更新全部同步
- **自動重連**：斷線後 3 秒自動重新連線

### 顯示資訊
- **WiFi 資訊**：根據模式顯示 SSID/密碼/IP/信號
- **連線裝置數**：目前連接的裝置數量
- **運行時間**：系統啟動後的運行秒數
- **可用記憶體**：ESP8266 剩餘 RAM

### 控制功能
- **文字輸入框**：輸入要顯示的文字（最多 200 字元）
- **更新按鈕**：送出文字並更新電子紙顯示
- **目前顯示**：顯示目前電子紙上的文字內容

## 🖼️ 電子紙顯示佈局

### Station 模式
```
┌─────────────────────────────────────────┐
│ Connected: YourWiFi                      │  ← 左上角
│ IP: 192.168.1.100                        │     WiFi 資訊
│ Signal: -45 dBm                          │
├─────────────────────────────────────────┤  ← 分隔線
│                                          │
│         ┌─────────────────┐             │
```

### AP 模式
```
┌─────────────────────────────────────────┐
│ WiFi SSID: EPaper_Display               │  ← 左上角
│ Password: 12345678                       │     WiFi 資訊
│ IP: 192.168.4.1                          │
├─────────────────────────────────────────┤  ← 分隔線
│                                          │
│         ┌─────────────────┐             │
│         │                 │             │
│         │  使用者輸入的   │             │  ← 中央區域
│         │  文字顯示在     │             │     使用者文字
│         │  這裡           │             │
│         │                 │             │
│         └─────────────────┘             │
│                                          │
└─────────────────────────────────────────┘
```

### 顯示區域說明
- **左上角**：WiFi SSID、密碼、IP 位址（小字體）
- **中央區域**：使用者輸入的文字（中等字體，自動換行）
- **邊框**：中央文字區域有黑色邊框裝飾

## 🔧 技術特點

### 記憶體優化
- 使用分頁模式（Paging Mode）
- RAM 緩衝僅 800 bytes
- 支援完整 800×480 解析度
- WiFi 啟用後仍有足夠記憶體

### WiFi 功能
- **雙模式支援**：AP 模式 / Station 模式（編譯選項）
- **Station 模式**：連接到現有 WiFi AP，支援 30 秒連線逾時
- **AP 熱點模式**：固定 IP 192.168.4.1，最多 4 個連線
- **802.11n 高速模式**：連線速度提升 178%
- **網頁自動更新**：WebSocket 即時同步狀態

### 電子紙更新
- 防抖動機制（2 秒延遲）
- 部分更新中央文字區域
- 完整更新 WiFi 資訊區域
- 自動換行處理長文字

## 📊 系統參數

| 項目 | 規格 |
|------|------|
| WiFi SSID | EPaper_Display |
| WiFi 密碼 | 12345678 |
| IP 位址 | 192.168.4.1 |
| 網頁埠號 | 80 (HTTP) |
| 序列埠速率 | 115200 |
| 電子紙解析度 | 800×480 |
| RAM 緩衝 | 800 bytes |
| 文字最大長度 | 200 字元 |
| 更新延遲 | 2 秒 |

## 🛠️ 自訂設定

### 修改 WiFi 設定
在程式碼中修改：
```cpp
const char* ap_ssid = "你的SSID";        // 修改熱點名稱
const char* ap_password = "你的密碼";    // 修改密碼（至少8個字元）
```

### 修改顯示佈局
調整中央文字區域大小：
```cpp
int16_t x = display.width() / 2 - 150;   // 調整 X 位置
int16_t y = display.height() / 2 - 40;   // 調整 Y 位置
int16_t w = 300;                         // 調整寬度
int16_t h = 160;                         // 調整高度
```

### 修改字體大小
```cpp
display.setFont(&FreeMonoBold9pt7b);     // 小字體
display.setFont(&FreeMonoBold12pt7b);    // 中等字體
display.setFont(&FreeMonoBold18pt7b);    // 大字體
```

## 🐛 故障排除

### 1. WiFi 連線問題

#### Station 模式無法連線
- 檢查 WiFi SSID 和密碼是否正確
- 確認 WiFi AP 在訊號範圍內（查看 RSSI 值）
- 觀察序列埠監控，等待 30 秒連線逾時
- 嘗試重新啟動 ESP8266

#### AP 模式熱點無法連接
- 檢查密碼是否至少 8 個字元
- 重新啟動 ESP8266
- 確認手機 WiFi 已開啟
- 查看序列埠確認熱點是否成功建立

### 2. 電子紙無顯示或 WiFi 資訊消失
- ✅ **已修正**：v1.1 移除了錯誤的 setPartialWindow() 調用
- 檢查硬體連接是否正確
- 確認電阻是否正確安裝
- 檢查序列埠是否有錯誤訊息
- 重新上傳程式

### 3. 網頁無法開啟
- ✅ **已改善**：v1.1 增加了 WiFi 初始化穩定性
- **Station 模式**：確認在同一 WiFi 網路下，使用電子紙顯示的 IP
- **AP 模式**：確認已連接到熱點，使用 `http://192.168.4.1`
- 嘗試使用 `http://` 而非 `https://`
- 清除瀏覽器快取
- 查看序列埠監控視窗確認伺服器是否啟動
- 等待 5-10 秒讓 WiFi 完全初始化

### 4. 記憶體不足
- 縮短顯示文字長度
- 減少同時連線裝置數
- 重新啟動 ESP8266

### 5. 文字顯示不完整
- 減少文字長度（建議 100 字元內）
- 使用較小的字體
- 調整中央區域大小

### 🔍 調試技巧
1. **開啟序列埠監控**（115200 baud）查看詳細日誌
2. **檢查 WiFi 狀態**：每 10 秒會顯示連線裝置數和記憶體
3. **網頁請求日誌**：每次網頁請求都會在序列埠顯示
4. **測試連接**：可以先訪問 `http://192.168.4.1/status` 查看 JSON 狀態

## 📡 API 端點

系統提供以下 HTTP 端點：

### GET /
主頁面，顯示控制介面（使用 PROGMEM + 分段傳輸優化）

### POST /update
更新顯示文字（v1.2：使用 AJAX，無需重新載入頁面）
- **參數**：`text` (要顯示的文字)
- **回應**：200 "OK" (v1.1: 302 重定向)

### GET /status
取得系統狀態（JSON 格式）
```json
{
  "text": "目前顯示的文字",
  "clients": 1,
  "uptime": 123,
  "freeHeap": 45678
}
```

## 🎨 進階應用

### 可能的擴充功能
1. **多頁面切換**：支援多個文字頁面
2. **圖片上傳**：透過網頁上傳圖片顯示
3. **定時更新**：設定定時自動更新內容
4. **QR Code**：產生 WiFi 連線 QR Code
5. **天氣資訊**：顯示即時天氣（需連接外部 WiFi）
6. **時鐘顯示**：顯示目前時間（需 NTP 同步）

## 📞 相關資源

- **GxEPD2 官方**：https://github.com/ZinggJM/GxEPD2
- **ESP8266 Arduino**：https://github.com/esp8266/Arduino
- **電子紙規格**：GDEQ0426T82 (800×480, SSD1677)

## 📝 版本記錄

### v1.4 (2025-10-04) - WiFi 雙模式 🔄
- 🆕 **WiFi Station 模式**：支援連接到現有的 WiFi AP
- 🆕 **編譯選項切換**：使用 `#define USE_WIFI_STATION` 切換模式
- 🆕 **Station 模式顯示**：顯示連接的 SSID、取得的 IP、信號強度
- 🆕 **30 秒連線逾時**：連線失敗後重試機制
- ✨ **網頁自適應**：根據模式自動顯示對應的 WiFi 資訊
- ✨ **電子紙自適應**：根據模式顯示不同的連線資訊
- 🔧 **預設 Station 模式**：更適合家庭/辦公室環境
- 📚 **文件**：README 新增模式切換教學

### v1.3 (2025-10-03) - 進階功能 🎯
- 🆕 **WebSocket 即時通訊**：雙向通訊，延遲降至 50ms
- 🆕 **進度顯示**：即時顯示更新進度（0% → 50% → 100%）
- 🆕 **連線狀態**：即時顯示 WebSocket 連線狀態（🟢/🔴）
- 🆕 **多客戶端同步**：一個裝置更新，所有裝置即時同步
- 🆕 **自動重連**：斷線後 3 秒自動重新連線
- 🆕 **GZIP 準備**：檢測客戶端支援，基礎架構完成
- 📚 **文件**：新增 V1.3_WEBSOCKET_FEATURES.md 詳細說明
- 🔧 **技術**：WebSocketsServer Port 81，JSON 訊息格式

### v1.2 (2025-10-03) - 速度優化 🚀
- 🚀 **重大改善**：WiFi 802.11n 高速模式（速度提升 178%）
- 🚀 **重大改善**：HTML PROGMEM + 分段傳輸（RAM 使用減少 83%）
- 🚀 **重大改善**：AJAX 快速更新（更新速度提升 87%）
- ⚡ **優化**：TX 功率增強至 20.5 dBm（信號更強）
- ⚡ **優化**：CSS 壓縮（大小減少 47%）
- ⚡ **優化**：靜態內容儲存在 Flash（節省 RAM）
- 📊 **效能**：頁面載入時間 1.5s → 0.5s
- 📊 **效能**：文字更新時間 1.5s → 0.2s
- 📚 **文件**：新增 PERFORMANCE_OPTIMIZATION.md 詳細說明

### v1.1 (2025-10-03) - 穩定性改進
- 🐛 **修正**：移除 drawCenteredText() 中錯誤的 setPartialWindow() 調用
- 🐛 **修正**：左上角 WiFi 資訊現在可以正常顯示
- ✨ **改善**：WiFi 初始化更穩定（增加延遲和錯誤處理）
- ✨ **新增**：詳細的序列埠調試日誌
- ✨ **新增**：每 10 秒自動顯示連線狀態和記憶體
- ✨ **新增**：404 錯誤處理
- ✨ **新增**：MAC 位址顯示
- 📝 **改善**：更清晰的啟動訊息和網頁請求日誌

### v1.0 (2025-10-02) - 初始版本
- ✅ 初始版本發布
- ✅ WiFi 熱點功能
- ✅ 網頁文字輸入
- ✅ 電子紙顯示整合
- ✅ 自動換行處理

---

**開發者**：Daniel YJ Hsieh  
**授權**：MIT License  
**最後更新**：2025-10-04
