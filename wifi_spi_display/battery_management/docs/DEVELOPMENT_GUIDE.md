# é›»æ± ä¾›é›»èˆ‡å……æ”¾é›»ç®¡ç† - é–‹ç™¼æµç¨‹èˆ‡æ¸¬è©¦è¨ˆç•«

æœ¬æ–‡ä»¶æä¾›å®Œæ•´çš„é–‹ç™¼æµç¨‹ã€éšæ®µæ€§é©—è­‰æ­¥é©Ÿã€æ¸¬è©¦æ–¹æ³•èˆ‡æ•…éšœæ’é™¤æŒ‡å—ï¼Œå¹«åŠ©ä½ é †åˆ©å®Œæˆé›»æ± ä¾›é›»ç³»çµ±æ•´åˆã€‚

---

## ğŸ¯ é–‹ç™¼ç¸½è¦½

æ•´å€‹é–‹ç™¼æµç¨‹åˆ†ç‚º **4 å€‹éšæ®µ**ï¼Œæ¯éšæ®µæœ‰æ˜ç¢ºçš„äº¤ä»˜æˆæœèˆ‡é©—æ”¶æ¨™æº–ï¼š

| éšæ®µ | ç›®æ¨™ | é ä¼°æ™‚é–“ | é©—æ”¶æ¨™æº– |
|------|------|---------|---------|
| Phase 1 | ç¡¬é«”çµ„è£èˆ‡é©—è­‰ | 1-2 å¤© | é›»æ± æ­£å¸¸å……æ”¾é›»ï¼Œé›»å£“æ­£ç¢º |
| Phase 2 | åŸºç¤éŸŒé«”é–‹ç™¼ | 2-3 å¤© | ADC è®€å–æº–ç¢ºï¼ŒDeep Sleep å¯å–šé†’ |
| Phase 3 | åŠŸèƒ½æ•´åˆæ¸¬è©¦ | 2-3 å¤© | èˆ‡ç¾æœ‰ç³»çµ±ç„¡ç¸«æ•´åˆï¼Œæ­£å¸¸é¡¯ç¤º |
| Phase 4 | é•·æœŸæ¸¬è©¦èˆ‡å„ªåŒ– | 5-7 å¤© | çºŒèˆªé”æ¨™ï¼Œç©©å®šé‹è¡Œ |

**ç¸½æ™‚ç¨‹**: ç´„ 10-15 å¤©ï¼ˆä¾ç¶“é©—èˆ‡ç¡¬é«”åˆ°è²¨é€Ÿåº¦èª¿æ•´ï¼‰

---

## ğŸ“¦ Phase 1: ç¡¬é«”çµ„è£èˆ‡é©—è­‰

### 1.1 ææ–™æº–å‚™

æŒ‰ç…§ `HARDWARE_ARCHITECTURE.md` çš„ BOM è¡¨æ¡è³¼ï¼š

- [ ] 18650 é›»æ±  Ã— 1ï¼ˆæ¨è–¦ 2600mAh+ï¼‰
- [ ] TP4056 å……é›»æ¨¡çµ„ï¼ˆå«ä¿è­·æ¿ï¼‰Ã— 1
- [ ] MT3608 å‡å£“æ¨¡çµ„ Ã— 1
- [ ] é›»é˜» 100kÎ© Ã— 1
- [ ] é›»é˜» 33kÎ© Ã— 1
- [ ] 18650 é›»æ± åº§ Ã— 1
- [ ] æœé‚¦ç·šè‹¥å¹²
- [ ] éºµåŒ…æ¿æˆ–æ´æ´æ¿ Ã— 1
- [ ] è¬ç”¨è¡¨ï¼ˆå¿…å‚™ï¼‰
- [ ] USB ç·šèˆ‡ 5V å……é›»å™¨

### 1.2 çµ„è£æ­¥é©Ÿ

#### æ­¥é©Ÿ 1: é›»æ± é€£æ¥ TP4056

```
âš ï¸ æ³¨æ„æ¥µæ€§ï¼åæ¥æœƒæå£æ¨¡çµ„ï¼

18650 æ­£æ¥µï¼ˆå‡¸èµ·ç«¯ï¼‰â†’ TP4056 B+
18650 è² æ¥µï¼ˆå¹³ç«¯ï¼‰  â†’ TP4056 B-
```

**é©—è­‰**:
- æ’å…¥ USB å……é›»å™¨ï¼ŒTP4056 ç´…ç‡ˆæ‡‰äº®èµ·ï¼ˆå……é›»ä¸­ï¼‰
- ç”¨è¬ç”¨è¡¨æ¸¬ B+ èˆ‡ B- é–“é›»å£“ï¼Œæ‡‰ç‚º 3.7V å·¦å³

#### æ­¥é©Ÿ 2: å……é›»æ¸¬è©¦

```
æ’å…¥ USB â†’ ç­‰å¾… 2-4 å°æ™‚ â†’ è—/ç¶ ç‡ˆäº®èµ·ï¼ˆå……æ»¿ï¼‰
```

**é©—è­‰**:
- å……æ»¿å¾Œé›»æ± é›»å£“æ‡‰ç‚º **4.15-4.20V**
- æ‹”æ‰ USBï¼ŒOUT+ èˆ‡ OUT- é–“é›»å£“ = é›»æ± é›»å£“ï¼ˆä¿è­·æ¿æ­£å¸¸ï¼‰

#### æ­¥é©Ÿ 3: å‡å£“æ¨¡çµ„æ¥ç·š

```
TP4056 OUT+ â†’ MT3608 IN+
TP4056 OUT- â†’ MT3608 IN- (å…±åœ°)
```

**èª¿æ•´è¼¸å‡ºé›»å£“**:
1. ç”¨è¬ç”¨è¡¨æ¸¬é‡ MT3608 çš„ OUT+ èˆ‡ OUT-
2. ç”¨å°èºçµ²åˆ€**é †æ™‚é‡**æ—‹è½‰é›»ä½å™¨å‡å£“ï¼Œ**é€†æ™‚é‡**é™å£“
3. èª¿æ•´è‡³ **5.0V Â±0.1V**

#### æ­¥é©Ÿ 4: ESP8266 ä¾›é›»æ¸¬è©¦

```
MT3608 OUT+ (5V) â†’ WeMos D1 Mini çš„ 5V è…³ä½
MT3608 OUT- (GND) â†’ WeMos D1 Mini çš„ GND
```

**é©—è­‰**:
- ESP8266 æ‡‰æ­£å¸¸é–‹æ©Ÿï¼ˆLED é–ƒçˆï¼‰
- ç”¨è¬ç”¨è¡¨æ¸¬ ESP8266 çš„ 3.3V è…³ä½ï¼Œæ‡‰ç‚º 3.3Vï¼ˆæ¿è¼‰ LDO æ­£å¸¸ï¼‰

#### æ­¥é©Ÿ 5: åˆ†å£“é›»è·¯çµ„è£

```
TP4056 OUT+ â”€â”¬â”€ R1(100kÎ©) â”€â”¬â”€ R2(33kÎ©) â”€â”¬â”€ GND
             â”‚               â”‚             â”‚
             â”‚               â””â”€> A0        â”‚
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é©—è­‰**ï¼ˆç”¨è¬ç”¨è¡¨æ¸¬ A0 ç¯€é»é›»å£“ï¼‰:
- é›»æ±  4.2V â†’ A0 æ‡‰ç‚º **~1.04V**
- é›»æ±  3.7V â†’ A0 æ‡‰ç‚º **~0.92V**
- é›»æ±  3.0V â†’ A0 æ‡‰ç‚º **~0.74V**

#### æ­¥é©Ÿ 6: å……é›»ç‹€æ…‹æª¢æ¸¬ï¼ˆå¯é¸ï¼‰

```
TP4056 CHRG  â†’ ESP8266 GPIO14 (D5)
TP4056 STDBY â†’ ESP8266 GPIO12 (D6)
```

**é©—è­‰**:
- å¯«ç°¡å–®ç¨‹å¼è®€å– GPIO14/12 ç‹€æ…‹
- æ’å…¥ USB å……é›»ï¼Œæ‡‰èƒ½æ­£ç¢ºè­˜åˆ¥ã€Œå……é›»ä¸­ã€èˆ‡ã€Œå……æ»¿ã€

### 1.3 éšæ®µé©—æ”¶

| æª¢æŸ¥é …ç›® | æœŸæœ›çµæœ | å¯¦æ¸¬çµæœ |
|---------|---------|---------|
| é›»æ± å……é›»è‡³ 4.2V | âœ… é€šé / âŒ å¤±æ•— | |
| å‡å£“è¼¸å‡ºç©©å®š 5V | âœ… é€šé / âŒ å¤±æ•— | |
| ESP8266 æ­£å¸¸é–‹æ©Ÿ | âœ… é€šé / âŒ å¤±æ•— | |
| ADC åˆ†å£“é›»å£“æ­£ç¢º | âœ… é€šé / âŒ å¤±æ•— | |
| å……é›»ç‹€æ…‹æª¢æ¸¬æ­£å¸¸ | âœ… é€šé / âŒ å¤±æ•— | |

---

## ğŸ’» Phase 2: åŸºç¤éŸŒé«”é–‹ç™¼

### 2.1 å»ºç«‹æ¸¬è©¦å°ˆæ¡ˆ

åœ¨ `battery_management/firmware/` ä¸‹å»ºç«‹æ¸¬è©¦ç¨‹å¼ï¼š

```
firmware/
â”œâ”€â”€ test_battery_monitor/
â”‚   â”œâ”€â”€ test_battery_monitor.ino
â”‚   â”œâ”€â”€ battery_monitor.h
â”‚   â””â”€â”€ battery_monitor.cpp
â””â”€â”€ test_power_manager/
    â”œâ”€â”€ test_power_manager.ino
    â”œâ”€â”€ power_manager.h
    â””â”€â”€ power_manager.cpp
```

### 2.2 æ¸¬è©¦ 1: ADC é›»å£“è®€å–

**ç›®æ¨™**: é©—è­‰ ADC è®€å–ç²¾åº¦èˆ‡æ¿¾æ³¢æ•ˆæœ

**æ¸¬è©¦ç¨‹å¼** (`test_battery_monitor.ino`):

```cpp
#include "battery_monitor.h"

BatteryMonitor battery;

void setup() {
    Serial.begin(115200);
    battery.begin();
    
    Serial.println("=== é›»æ± ç›£æ§æ¸¬è©¦ ===");
}

void loop() {
    float voltage = battery.readVoltage();
    uint8_t percent = battery.getPercentage();
    BatteryMonitor::BatteryState state = battery.getState();
    bool charging = battery.isCharging();
    
    Serial.printf("é›»å£“: %.3fV | é›»é‡: %d%% | ç‹€æ…‹: %s | å……é›»: %s\n",
                  voltage, percent, 
                  battery.getStateString(state),
                  charging ? "æ˜¯" : "å¦");
    
    delay(1000);
}
```

**é©—æ”¶æ¨™æº–**:
- [ ] é›»å£“è®€å€¼èˆ‡è¬ç”¨è¡¨èª¤å·® < 0.1V
- [ ] æ¿¾æ³¢å¾Œè®€å€¼ç©©å®šï¼ˆæ³¢å‹• < 0.05Vï¼‰
- [ ] å……é›»ç‹€æ…‹æ­£ç¢ºè­˜åˆ¥
- [ ] ç™¾åˆ†æ¯”å°æ‡‰åˆç†ï¼ˆ4.2V=100%, 3.0V=0%ï¼‰

### 2.3 æ¸¬è©¦ 2: Deep Sleep å–šé†’

**ç›®æ¨™**: é©—è­‰ Deep Sleep é€²å…¥èˆ‡å®šæ™‚å–šé†’

**é‡è¦**: å¿…é ˆå°‡ **GPIO16 (D0)** é€£æ¥åˆ° **RST**ï¼

**æ¸¬è©¦ç¨‹å¼** (`test_power_manager.ino`):

```cpp
void setup() {
    Serial.begin(115200);
    delay(1000); // ç­‰å¾…åºåˆ—åŸ ç©©å®š
    
    Serial.println("=== Deep Sleep æ¸¬è©¦ ===");
    Serial.println("å–šé†’åŸå› : " + ESP.getResetReason());
    
    // è®€å–å–šé†’æ¬¡æ•¸ï¼ˆå­˜åœ¨ RTC è¨˜æ†¶é«”ï¼‰
    uint32_t count = 0;
    ESP.rtcUserMemoryRead(0, &count, sizeof(count));
    count++;
    ESP.rtcUserMemoryWrite(0, &count, sizeof(count));
    
    Serial.printf("å–šé†’æ¬¡æ•¸: %d\n", count);
    Serial.println("10 ç§’å¾Œé€²å…¥ Deep Sleep (30 ç§’)...");
    
    delay(10000);
    
    Serial.println("é€²å…¥ Deep Sleep");
    Serial.flush();
    
    // Deep Sleep 30 ç§’
    ESP.deepSleep(30 * 1000000ULL); // å¾®ç§’
}

void loop() {
    // ä¸æœƒåŸ·è¡Œåˆ°é€™è£¡
}
```

**é©—æ”¶æ¨™æº–**:
- [ ] æ¯ 30 ç§’è‡ªå‹•å–šé†’ä¸€æ¬¡
- [ ] å–šé†’æ¬¡æ•¸æ­£ç¢ºç´¯åŠ 
- [ ] Deep Sleep æœŸé–“é›»æµ < 0.1mAï¼ˆéœ€é›»æµè¡¨ï¼‰
- [ ] åºåˆ—åŸ è¼¸å‡ºæ­£å¸¸

### 2.4 æ¸¬è©¦ 3: ä½é›»é‡ä¿è­·

**æ¨¡æ“¬æ–¹æ³•**: ä¿®æ”¹ `battery_monitor.cpp` çš„é›»å£“æ ¡æ­£ä¿‚æ•¸ï¼Œè®“ ADC è®€å€¼ä½æ–¼ 3.0V

```cpp
// è‡¨æ™‚ä¿®æ”¹ï¼ˆæ¸¬è©¦ç”¨ï¼‰
float BatteryMonitor::readVoltage() {
    return 2.9; // æ¨¡æ“¬ä½é›»é‡
}
```

**é©—æ”¶æ¨™æº–**:
- [ ] æª¢æ¸¬åˆ°ä½é›»é‡æ™‚ï¼Œç¨‹å¼ç«‹å³é€²å…¥ Deep Sleep
- [ ] è¨­å®šç‚ºã€Œä¸å–šé†’ã€ï¼ˆsleepTime = 0 æˆ–è¶…é•·æ™‚é–“ï¼‰
- [ ] åºåˆ—åŸ è¼¸å‡ºè­¦å‘Šè¨Šæ¯

### 2.5 éšæ®µé©—æ”¶

| åŠŸèƒ½æ¨¡çµ„ | æ¸¬è©¦çµæœ | å‚™è¨» |
|---------|---------|------|
| ADC é›»å£“è®€å– | âœ… / âŒ | èª¤å·®: ____V |
| é›»é‡ç™¾åˆ†æ¯”è¨ˆç®— | âœ… / âŒ | |
| å……é›»ç‹€æ…‹æª¢æ¸¬ | âœ… / âŒ | |
| Deep Sleep é€²å…¥ | âœ… / âŒ | |
| å®šæ™‚å–šé†’ | âœ… / âŒ | èª¤å·®: ____ç§’ |
| ä½é›»é‡ä¿è­· | âœ… / âŒ | |

---

## ğŸ”— Phase 3: åŠŸèƒ½æ•´åˆæ¸¬è©¦

### 3.1 æ•´åˆåˆ°ç¾æœ‰å°ˆæ¡ˆ

è¤‡è£½æ¸¬è©¦é€šéçš„ `battery_monitor.h/cpp` èˆ‡ `power_manager.h/cpp` åˆ°ï¼š

```
client_esp8266/
â”œâ”€â”€ client_esp8266.ino
â”œâ”€â”€ config.h
â”œâ”€â”€ protocol.h
â”œâ”€â”€ battery_monitor.h    â† æ–°å¢
â”œâ”€â”€ battery_monitor.cpp  â† æ–°å¢
â”œâ”€â”€ power_manager.h      â† æ–°å¢
â””â”€â”€ power_manager.cpp    â† æ–°å¢
```

### 3.2 ä¿®æ”¹ config.h

æŒ‰ç…§ `SOFTWARE_ARCHITECTURE.md` çš„ç¯„ä¾‹æ–°å¢é…ç½®å€å¡Šã€‚

### 3.3 ä¿®æ”¹ä¸»ç¨‹å¼

**setup() åŠ å…¥é›»æ± åˆå§‹åŒ–**:

```cpp
void setup() {
    Serial.begin(115200);
    
    // === é›»æ± ç®¡ç†åˆå§‹åŒ– ===
    batteryMonitor.begin();
    powerManager.begin(&batteryMonitor);
    
    // æª¢æŸ¥é›»æ± ç‹€æ…‹
    float voltage = batteryMonitor.readVoltage();
    Serial.printf("é›»æ± : %.2fV\n", voltage);
    
    if (batteryMonitor.getState() == BatteryMonitor::BATTERY_CRITICAL) {
        Serial.println("âš ï¸ é›»é‡éä½ï¼Œç„¡æ³•å•Ÿå‹•");
        powerManager.enterDeepSleep(0);
        return;
    }
    
    // === åŸæœ‰åˆå§‹åŒ– ===
    connectWiFi();
    initWebSocket();
    initDisplay();
}
```

**loop() åŠ å…¥é›»æ± æª¢æŸ¥**:

```cpp
void loop() {
    webSocket.loop();
    
    // å®šæœŸæª¢æŸ¥é›»æ± ï¼ˆæ¯ 30 ç§’ï¼‰
    static unsigned long lastCheck = 0;
    if (millis() - lastCheck > 30000) {
        float voltage = batteryMonitor.readVoltage();
        Serial.printf("é›»æ± : %.2fV\n", voltage);
        
        if (batteryMonitor.getState() == BatteryMonitor::BATTERY_LOW) {
            powerManager.handleLowBattery();
        }
        
        lastCheck = millis();
    }
    
    // æª¢æŸ¥æ˜¯å¦éœ€è¦ä¼‘çœ 
    if (powerManager.shouldSleep()) {
        uint64_t sleepTime = powerManager.getDefaultSleepTime();
        powerManager.enterDeepSleep(sleepTime);
    }
    
    delay(100);
}
```

### 3.4 æ•´åˆæ¸¬è©¦æ¡ˆä¾‹

#### æ¸¬è©¦æ¡ˆä¾‹ 1: å®Œæ•´æ›´æ–°æµç¨‹

1. ESP8266 å¾ Deep Sleep å–šé†’
2. é€£æ¥ WiFi
3. é€£æ¥ WebSocket Server
4. æ¥æ”¶ä¸¦é¡¯ç¤ºåœ–åƒ
5. æª¢æŸ¥é›»æ± ç‹€æ…‹
6. é€²å…¥ Deep Sleepï¼ˆ1 å°æ™‚ï¼‰

**é©—æ”¶æ¨™æº–**:
- [ ] æ•´å€‹æµç¨‹é †æš¢ï¼Œç„¡å¡é “æˆ–é‡å•Ÿ
- [ ] é›»æ± é›»å£“èˆ‡ç‹€æ…‹æ­£ç¢ºå›å‚³çµ¦ Server
- [ ] Deep Sleep å–šé†’é€±æœŸæº–ç¢º

#### æ¸¬è©¦æ¡ˆä¾‹ 2: å……é›»æ™‚è¡Œç‚º

1. é€£æ¥ USB å……é›»
2. ESP8266 åµæ¸¬åˆ°å……é›»ç‹€æ…‹
3. èª¿æ•´å–šé†’é–“éš”ç‚º 30 åˆ†é˜ï¼ˆé™ä½é »ç‡ï¼‰

**é©—æ”¶æ¨™æº–**:
- [ ] å……é›»ç‹€æ…‹æ­£ç¢ºè­˜åˆ¥
- [ ] å–šé†’é–“éš”è‡ªå‹•èª¿æ•´
- [ ] å……é›»æŒ‡ç¤ºç‡ˆæ­£å¸¸ï¼ˆç´…â†’è—/ç¶ ï¼‰

#### æ¸¬è©¦æ¡ˆä¾‹ 3: ä½é›»é‡å ´æ™¯

1. æ¨¡æ“¬é›»æ± é›»å£“é™è‡³ 3.2V
2. ç³»çµ±ç™¼å‡ºä½é›»é‡è­¦å‘Š
3. è‡ªå‹•é€²å…¥çœé›»æ¨¡å¼ï¼ˆ3 å°æ™‚å–šé†’ï¼‰

**é©—æ”¶æ¨™æº–**:
- [ ] è­¦å‘Šè¨Šæ¯é€é WebSocket å‚³é€
- [ ] è‡ªå‹•å»¶é•·ä¼‘çœ æ™‚é–“
- [ ] æ¥µä½é›»é‡ï¼ˆ<3.0Vï¼‰æ™‚ä¸å†å–šé†’

### 3.5 éšæ®µé©—æ”¶

| æ•´åˆåŠŸèƒ½ | æ¸¬è©¦çµæœ | å‚™è¨» |
|---------|---------|------|
| é›»æ± ç›£æ§èˆ‡é¡¯ç¤ºç³»çµ±ç„¡è¡çª | âœ… / âŒ | |
| WiFi é€£æ¥æ­£å¸¸ | âœ… / âŒ | |
| åœ–åƒæ›´æ–°æ­£å¸¸ | âœ… / âŒ | |
| Deep Sleep ä¸å½±éŸ¿ä¸‹æ¬¡å–šé†’ | âœ… / âŒ | |
| Server æ”¶åˆ°é›»æ± ç‹€æ…‹ | âœ… / âŒ | |
| ä½é›»é‡è‡ªå‹•ä¿è­· | âœ… / âŒ | |

---

## â±ï¸ Phase 4: é•·æœŸæ¸¬è©¦èˆ‡å„ªåŒ–

### 4.1 çºŒèˆªæ¸¬è©¦

**æ¸¬è©¦æ–¹æ³•**:

1. é›»æ± å……æ»¿ï¼ˆ4.2Vï¼‰
2. å•Ÿå‹•è£ç½®ï¼Œè¨­å®šæ¯å°æ™‚æ›´æ–°ä¸€æ¬¡
3. è¨˜éŒ„é›»æ± é›»å£“è®ŠåŒ–
4. ç›´åˆ°é›»æ± é™è‡³ 3.0V æˆ–è‡ªå‹•é—œæ©Ÿ

**è¨˜éŒ„è¡¨æ ¼**:

| æ™‚é–“ (å°æ™‚) | é›»å£“ (V) | ç™¾åˆ†æ¯” (%) | å–šé†’æ¬¡æ•¸ | å‚™è¨» |
|------------|---------|-----------|---------|------|
| 0 | 4.20 | 100% | 0 | åˆå§‹å……æ»¿ |
| 24 | 4.15 | ~95% | 24 | |
| 48 | 4.08 | ~85% | 48 | |
| 72 | 4.00 | ~75% | 72 | |
| ... | ... | ... | ... | |
| X | 3.00 | ~5% | Y | è‡ªå‹•é—œæ©Ÿ |

**ç›®æ¨™çºŒèˆª**:
- **ä½é »æ›´æ–°** (æ¯å¤© 1 æ¬¡): > 60 å¤©
- **ä¸­é »æ›´æ–°** (æ¯å°æ™‚ 1 æ¬¡): > 5 å¤©
- **é«˜é »æ›´æ–°** (æ¯ 15 åˆ†é˜): > 2 å¤©

### 4.2 åŠŸè€—å„ªåŒ–

è‹¥çºŒèˆªä¸é”æ¨™ï¼Œä¾åºæª¢æŸ¥ï¼š

#### å„ªåŒ– 1: WiFi çœé›»æ¨¡å¼

```cpp
WiFi.setSleepMode(WIFI_LIGHT_SLEEP);
WiFi.setOutputPower(15); // é™ä½ TX Power
```

#### å„ªåŒ– 2: é™ä½ CPU é »ç‡

```cpp
system_update_cpu_freq(80); // éé—œéµæ™‚æ®µ 80MHz
```

#### å„ªåŒ– 3: é—œé–‰ä¸å¿…è¦çš„ GPIO

```cpp
// é—œé–‰æ¿è¼‰ LED
pinMode(LED_BUILTIN, OUTPUT);
digitalWrite(LED_BUILTIN, HIGH);
```

#### å„ªåŒ– 4: ç¸®çŸ­æ´»å‹•æ™‚é–“

```cpp
// åŸæœ¬ 30 ç§’è¶…æ™‚ï¼Œæ”¹ç‚º 15 ç§’
#define ACTIVE_TIMEOUT 15
```

### 4.3 ç©©å®šæ€§æ¸¬è©¦

**æ¸¬è©¦é …ç›®**:

1. **é‡è¤‡å–šé†’æ¸¬è©¦**: é€£çºŒå–šé†’ 100 æ¬¡ï¼Œè¨˜éŒ„å¤±æ•—æ¬¡æ•¸
2. **WiFi é€£æ¥æ¸¬è©¦**: é è·é›¢æˆ–å¼±è¨Šè™Ÿç’°å¢ƒï¼Œæ¸¬è©¦é‡é€£æ©Ÿåˆ¶
3. **æº«åº¦æ¸¬è©¦**: å……é›»æ™‚æ¸¬é‡ TP4056 èˆ‡ ESP8266 æº«åº¦ï¼ˆ< 60Â°Cï¼‰
4. **è·Œè½æ¸¬è©¦**: æ¨¡æ“¬æ„å¤–æ‰è½ï¼Œæª¢æŸ¥é›»æ± èˆ‡æ¥ç·š

### 4.4 éšæ®µé©—æ”¶

| æ¸¬è©¦é …ç›® | ç›®æ¨™å€¼ | å¯¦æ¸¬å€¼ | çµæœ |
|---------|-------|-------|------|
| çºŒèˆªæ™‚é–“ï¼ˆæ¯å°æ™‚æ›´æ–°ï¼‰| > 5 å¤© | ____ å¤© | âœ… / âŒ |
| Deep Sleep é›»æµ | < 0.1mA | ____ mA | âœ… / âŒ |
| å–šé†’æˆåŠŸç‡ | > 99% | ____ % | âœ… / âŒ |
| å……é›»æº«åº¦ | < 60Â°C | ____ Â°C | âœ… / âŒ |
| é•·æœŸç©©å®šæ€§ | > 7 å¤©ç„¡æ•…éšœ | ____ å¤© | âœ… / âŒ |

---

## ğŸ› æ•…éšœæ’é™¤æŒ‡å—

### å•é¡Œ 1: é›»æ± å……é›»ç·©æ…¢æˆ–ä¸å……é›»

**å¯èƒ½åŸå› **:
- USB ä¾›é›»ä¸è¶³ï¼ˆ< 500mAï¼‰
- TP4056 çš„ Rprog é›»é˜»éå¤§

**è§£æ±ºæ–¹æ³•**:
1. æ›´æ› 5V/2A å……é›»å™¨
2. æª¢æŸ¥ USB ç·šå“è³ªï¼ˆæ•¸æ“šç·š vs å……é›»ç·šï¼‰
3. æ¸¬é‡ TP4056 çš„ IN+ èˆ‡ IN- é›»å£“ï¼ˆæ‡‰ç‚º 5Vï¼‰
4. è‹¥éœ€åŠ é€Ÿå……é›»ï¼Œæ›´æ› Rprog é›»é˜»ç‚º 1kÎ©ï¼ˆ1Aï¼‰æˆ– 0.5kÎ©ï¼ˆ2Aï¼‰

### å•é¡Œ 2: ESP8266 é‡å•Ÿæˆ–ä¸ç©©å®š

**å¯èƒ½åŸå› **:
- å‡å£“æ¨¡çµ„è¼¸å‡ºé›»å£“ä¸ç©©å®š
- é›»æ± é›»é‡ä¸è¶³ï¼ˆ< 3.5Vï¼‰
- WiFi ç¬é–“é›»æµéå¤§

**è§£æ±ºæ–¹æ³•**:
1. æª¢æŸ¥ MT3608 è¼¸å‡ºé›»å£“æ˜¯å¦ç©©å®š 5V
2. åœ¨ MT3608 è¼¸å‡ºç«¯åŠ  100ÂµF é›»è§£é›»å®¹ï¼ˆç·©è¡ï¼‰
3. å……æ»¿é›»æ± å¾Œå†æ¸¬è©¦
4. é™ä½ WiFi TX Power: `WiFi.setOutputPower(15)`

### å•é¡Œ 3: ADC è®€å€¼é£„ç§»æˆ–ä¸æº–

**å¯èƒ½åŸå› **:
- åˆ†å£“é›»é˜»å€¼èª¤å·®å¤§
- é›»æºå™ªè²å¹²æ“¾
- ADC æœªåšå¤šæ¬¡æ¡æ¨£å¹³å‡

**è§£æ±ºæ–¹æ³•**:
1. æ›´æ› 1% ç²¾åº¦é›»é˜»ï¼ˆé‡‘å±¬è†œé›»é˜»ï¼‰
2. åœ¨ ADC è¼¸å…¥ç«¯åŠ  0.1ÂµF é™¶ç“·é›»å®¹åˆ° GND
3. ç¨‹å¼ç¢¼åŠ å…¥å¤šæ¬¡æ¡æ¨£å¹³å‡ï¼š

```cpp
float readVoltageAverage() {
    float sum = 0;
    for (int i = 0; i < 10; i++) {
        sum += analogRead(A0);
        delay(10);
    }
    return (sum / 10.0) * VOLTAGE_CALIBRATION;
}
```

### å•é¡Œ 4: Deep Sleep å¾Œç„¡æ³•å–šé†’

**å¯èƒ½åŸå› **:
- GPIO16 (D0) æœªé€£æ¥ RST
- ç„Šæ¥ä¸è‰¯æˆ–æ¥è§¸ä¸è‰¯

**è§£æ±ºæ–¹æ³•**:
1. ç”¨è¬ç”¨è¡¨æ¸¬é‡ D0 èˆ‡ RST ä¹‹é–“æ˜¯å¦å°é€š
2. é‡æ–°ç„Šæ¥æˆ–æ›´æ›æœé‚¦ç·š
3. æ¸¬è©¦ç¨‹å¼ï¼š

```cpp
void setup() {
    Serial.begin(115200);
    Serial.println("æ¸¬è©¦ Deep Sleep å–šé†’");
    delay(5000);
    ESP.deepSleep(10e6); // 10 ç§’
}
```

### å•é¡Œ 5: çºŒèˆªæ™‚é–“é ä½æ–¼é æœŸ

**æª¢æŸ¥æ¸…å–®**:
- [ ] Deep Sleep é›»æµæ˜¯å¦ < 0.1mAï¼ˆç”¨é›»æµè¡¨é‡æ¸¬ï¼‰
- [ ] WiFi æ˜¯å¦æ­£ç¢ºé—œé–‰ï¼ˆæª¢æŸ¥ `WiFi.disconnect()` èˆ‡ `WiFi.mode(WIFI_OFF)`ï¼‰
- [ ] E-Paper æ˜¯å¦é€²å…¥ä¼‘çœ ï¼ˆ`display.hibernate()`ï¼‰
- [ ] æ˜¯å¦æœ‰ `delay()` æˆ– `while()` å°è‡´ CPU ç©ºè½‰
- [ ] æ¿è¼‰ LED æ˜¯å¦é—œé–‰

---

## ğŸ“Š é‡æ¸¬å·¥å…·èˆ‡æ–¹æ³•

### é›»æµé‡æ¸¬

**å·¥å…·**: æ•¸ä½è¬ç”¨è¡¨ï¼ˆæ”¯æ´ ÂµA æª”ä½ï¼‰æˆ– USB é›»æµè¡¨

**æ–¹æ³• 1: ç›´æ¥ä¸²è¯**ï¼ˆæœ€æº–ç¢ºï¼‰

```
é›»æ±  â†’ [è¬ç”¨è¡¨ ÂµA æª”] â†’ ESP8266
```

**æ–¹æ³• 2: USB é›»æµè¡¨**ï¼ˆç°¡ä¾¿ï¼‰

```
å……é›»å™¨ â†’ [USB é›»æµè¡¨] â†’ TP4056
```

**å…¸å‹è®€å€¼**:
- Active (WiFi): 100-170 mA
- Deep Sleep: 0.02-0.1 mAï¼ˆç†æƒ³å€¼ < 0.02 mAï¼‰

### é›»å£“é‡æ¸¬

**å·¥å…·**: æ•¸ä½è¬ç”¨è¡¨

**æ¸¬é‡é»**:
- é›»æ± é›»å£“: B+ èˆ‡ B- ä¹‹é–“
- å‡å£“è¼¸å‡º: OUT+ èˆ‡ OUT- ä¹‹é–“
- ADC è¼¸å…¥: A0 èˆ‡ GND ä¹‹é–“

### æº«åº¦é‡æ¸¬

**å·¥å…·**: ç´…å¤–ç·šæ¸¬æº«æ§æˆ–ç†±é›»å¶

**æ¸¬é‡é»**:
- TP4056 IC è¡¨é¢ï¼ˆå……é›»æ™‚ï¼‰
- MT3608 IC è¡¨é¢
- ESP8266 æ¨¡çµ„ï¼ˆWiFi å‚³è¼¸æ™‚ï¼‰

**å®‰å…¨ç¯„åœ**: < 70Â°C

---

## ğŸ“ æ¸¬è©¦å ±å‘Šç¯„æœ¬

```markdown
## é›»æ± ä¾›é›»ç³»çµ±æ¸¬è©¦å ±å‘Š

**æ¸¬è©¦æ—¥æœŸ**: 2025-XX-XX  
**æ¸¬è©¦äººå“¡**: ______  
**ç¡¬é«”ç‰ˆæœ¬**: v1.0  
**éŸŒé«”ç‰ˆæœ¬**: v1.0  

### Phase 1: ç¡¬é«”é©—è­‰
- [x] é›»æ± å……é›»è‡³ 4.2V
- [x] å‡å£“è¼¸å‡ºç©©å®š 5V
- [x] ESP8266 æ­£å¸¸é–‹æ©Ÿ
- [x] ADC åˆ†å£“é›»å£“æ­£ç¢ºï¼ˆèª¤å·® 0.05Vï¼‰
- [x] å……é›»ç‹€æ…‹æª¢æ¸¬æ­£å¸¸

### Phase 2: éŸŒé«”æ¸¬è©¦
- [x] ADC è®€å–ç²¾åº¦: èª¤å·® 0.08V
- [x] Deep Sleep å–šé†’: 30 ç§’é€±æœŸï¼Œèª¤å·® < 1 ç§’
- [x] ä½é›»é‡ä¿è­·: 3.0V è‡ªå‹•é—œæ©Ÿ

### Phase 3: æ•´åˆæ¸¬è©¦
- [x] å®Œæ•´æ›´æ–°æµç¨‹é †æš¢
- [x] å……é›»æ™‚è‡ªå‹•èª¿æ•´å–šé†’é–“éš”
- [x] ä½é›»é‡è­¦å‘Šæ­£å¸¸å‚³é€

### Phase 4: é•·æœŸæ¸¬è©¦
- çºŒèˆªæ™‚é–“: **7.2 å¤©**ï¼ˆæ¯å°æ™‚æ›´æ–°ä¸€æ¬¡ï¼‰
- Deep Sleep é›»æµ: **0.03 mA**
- å–šé†’æˆåŠŸç‡: **100%** (100/100)
- å……é›»æº«åº¦: **45Â°C**

### çµè«–
âœ… å…¨éƒ¨æ¸¬è©¦é€šéï¼Œç³»çµ±é”åˆ°é æœŸç›®æ¨™ã€‚

### æ”¹é€²å»ºè­°
1. è€ƒæ…®åŠ å…¥é›»é‡é¡¯ç¤º LEDï¼ˆ3 æ®µå¼ï¼‰
2. å¢åŠ å¤ªé™½èƒ½å……é›»æ¥å£
```

---

## ğŸ“ é–‹ç™¼æŠ€å·§èˆ‡å»ºè­°

### å»ºè­° 1: åˆ†éšæ®µæäº¤ Git

```bash
# Phase 1 å®Œæˆå¾Œ
git add battery_management/
git commit -m "feat(battery): Add hardware design and BOM"

# Phase 2 å®Œæˆå¾Œ
git commit -m "feat(battery): Implement battery monitor and power manager"

# Phase 3 å®Œæˆå¾Œ
git commit -m "feat(battery): Integrate battery management with main system"
```

### å»ºè­° 2: ä½¿ç”¨åºåˆ—åŸ æ—¥èªŒç›£æ§

```cpp
// åŠ å…¥æ™‚é–“æˆ³è¨˜
Serial.printf("[%lu] é›»æ± : %.2fV\n", millis(), voltage);
```

### å»ºè­° 3: RTC è¨˜æ†¶é«”å„²å­˜ç‹€æ…‹

```cpp
// å„²å­˜å–šé†’æ¬¡æ•¸ã€ç´¯è¨ˆé›»é‡ç­‰
struct RTCData {
    uint32_t wakeCount;
    float totalEnergy;
};

RTCData rtcData;
ESP.rtcUserMemoryRead(0, (uint32_t*)&rtcData, sizeof(rtcData));
```

### å»ºè­° 4: ä½¿ç”¨çœ‹é–€ç‹—å®šæ™‚å™¨

```cpp
ESP.wdtEnable(5000); // 5 ç§’çœ‹é–€ç‹—
// å®šæœŸé¤µç‹—
ESP.wdtFeed();
```

---

## ğŸ“š åƒè€ƒè³‡æº

- [Arduino ESP8266 Core å®˜æ–¹æ–‡ä»¶](https://arduino-esp8266.readthedocs.io/)
- [GxEPD2 é¡¯ç¤ºåº« Deep Sleep ç¯„ä¾‹](https://github.com/ZinggJM/GxEPD2/tree/master/examples)
- [ESP8266 ä½åŠŸè€—æ‡‰ç”¨ç­†è¨˜ (PDF)](https://www.espressif.com/sites/default/files/9b-esp8266-low_power_solutions_en_0.pdf)

---

**ç‰ˆæœ¬**: 1.0  
**æ’°å¯«æ—¥æœŸ**: 2025-10-12  
**ç¶­è­·**: battery_management å°ˆæ¡ˆåœ˜éšŠ
