# 電池供電方案 B - 利用 ESP8266 板載 USB 充電

本方案利用 WeMos D1 Mini 等 ESP8266 開發板的 **板載 USB 接口與充電電路**，簡化硬體設計，直接由電池供電並透過 USB 充電。

---

## 🎯 方案優勢

相較於方案 A（外部 TP4056 + 升壓模組），本方案具有：
- ✅ **硬體極簡**: 只需電池 + 保護板，無需額外充電/升壓模組
- ✅ **成本更低**: BOM 成本 < NT$100（省去 TP4056 + MT3608）
- ✅ **體積更小**: 減少 2 個模組，適合緊湊空間
- ✅ **接線簡單**: 電池直接接 ESP8266 的電源腳位
- ✅ **原生支援**: 利用開發板現有的 USB-to-Serial 與 LDO

---

## 📊 系統架構圖

### 架構總覽

```
USB 5V (板載) ─┬─> [CP2102 USB-Serial] ─> UART (程式上傳/序列埠)
               │
               └─> [板載充電電路*] ─┬─> [鋰電池 3.7V + 保護板]
                                    │         │
                                    │         └─> [ADC 分壓] ─> A0
                                    │
                                    └─> [板載 LDO AMS1117-3.3] ─> 3.3V ─┬─> ESP8266
                                                                        └─> E-Paper

* 部分開發板有板載充電電路（如 TP4056），部分沒有
```

---

## 🔍 方案分類

### 方案 B1: 開發板**有**板載充電電路

**適用板子**（以下板子通常有板載 TP4056 或類似充電 IC）:
- WeMos D1 Mini Pro（部分版本）
- NodeMCU V3（部分版本有 BAT 接口）
- Lolin D1 Mini Battery Shield

**特點**:
- 直接將鋰電池接到 BAT+/BAT- 接口
- USB 插入時自動充電
- 無需外加任何模組

**接線**:
```
鋰電池 3.7V + 保護板
   │
   ├─ 正極 → 開發板 BAT+ 或 VCC (透過充電電路)
   └─ 負極 → 開發板 GND

分壓電路（電量偵測）
   BAT+ ─┬─ 100kΩ ─┬─ 33kΩ ─┬─ GND
         │          └───────> A0
         │
         └─────────────────> (用於供電)
```

**優點**:
- 最簡單，無需任何外加模組
- 原廠設計，穩定可靠

**缺點**:
- 並非所有開發板都有此功能
- 充電電流通常較小（~500mA）

---

### 方案 B2: 開發板**沒有**板載充電電路（推薦）

**適用板子**（大多數標準 WeMos D1 Mini / NodeMCU）:
- WeMos D1 Mini（基礎版）
- NodeMCU V2/V3（無 BAT 接口版本）
- ESP-12E/F 模組

**特點**:
- 需加一個小型 TP4056 充電板（帶保護）
- 電池接 TP4056，TP4056 輸出接開發板的 5V/3.3V 腳位
- USB 充電時，開發板的 USB 與 TP4056 輸入可並聯

**架構圖**:
```
USB 線 (5V) ──┬──> ESP8266 板載 USB (程式上傳/序列埠)
              │
              └──> TP4056 IN+ (充電)
                      │
                      ├─ B+ ─┬─> 鋰電池 3.7V + 保護板
                      │      └─> [分壓電路] ─> A0
                      │
                      └─ OUT+ ──> ESP8266 的 **3.3V 腳位** (直接供電)
                         OUT- ──> ESP8266 GND
```

**關鍵設計**:
1. **電池輸出接 ESP8266 的 3.3V 腳位**（繞過板載 LDO）
2. **USB 充電時**，CP2102 透過板載 USB 供電，TP4056 同時對電池充電
3. **電池供電時**，電池透過 TP4056 保護板直接供應 3.3V 給 ESP8266

---

## 🔧 方案 B2 詳細設計（推薦實作）

### 為何接 3.3V 而非 5V？

| 接腳 | 優點 | 缺點 | 可行性 |
|------|------|------|--------|
| 5V 腳位 | 利用板載 LDO 穩壓 | 電池 3.0-4.2V 無法通過 LDO（需 > 4.5V）| ❌ 不可行 |
| 3.3V 腳位 | 直接供電，繞過 LDO | 電壓波動較大（3.0-4.2V）| ⚠️ 需保護 |
| VCC (直接接 ESP) | 最高效率 | 需焊接，不適合開發板 | ❌ 複雜 |

**解決方案**: 
- 使用 3.3V 腳位，但加入保護機制：
  1. 軟體監控電壓，< 3.0V 立即 Deep Sleep
  2. 使用帶保護板的電池（防過放）
  3. 電池電壓 3.0-4.2V 範圍內，ESP8266 仍能正常工作（規格書允許 3.0-3.6V）

### 完整硬體 BOM

| 項目 | 型號/規格 | 數量 | 單價 (NT$) | 備註 |
|------|----------|------|-----------|------|
| 鋰電池 | 18650 2600mAh (帶保護板) | 1 | 80 | 必須帶保護板 |
| TP4056 模組 | 含保護 DW01A | 1 | 20 | 微型版（17×12mm）|
| 電阻 | 100kΩ 1/4W | 1 | 1 | 分壓電路 |
| 電阻 | 33kΩ 1/4W | 1 | 1 | 分壓電路 |
| 杜邦線 | 母對母 | 4 | 5 | 連接用 |
| **總計** | | | **107** | |

> 相較方案 A 省去 MT3608 升壓模組（NT$15-20）

---

## 🔌 接線步驟

### 步驟 1: TP4056 與電池連接

```
18650 電池（帶保護板）
   │
   ├─ 正極 (+) → TP4056 B+
   └─ 負極 (-) → TP4056 B-
```

### 步驟 2: USB 充電輸入

```
選項 1: 獨立 USB 線給 TP4056
   USB 充電器 5V → TP4056 IN+
   USB GND      → TP4056 IN-

選項 2: 共用 ESP8266 的 USB（需二極體隔離）
   ESP8266 USB 5V ─┬─> ESP8266 板載電路
                   └─> [1N5819 二極體] ─> TP4056 IN+
```

> **建議**: 使用選項 1（獨立 USB），避免充電電流倒灌到 ESP8266 的 USB

### 步驟 3: 電池輸出至 ESP8266

```
TP4056 OUT+ ──> ESP8266 **3.3V** 腳位
TP4056 OUT- ──> ESP8266 GND
```

⚠️ **重要**: 
- 接到 **3.3V 腳位**，不是 5V！
- 確認電池電壓在 3.0-4.2V 範圍
- ESP8266 3.3V 供電範圍: 3.0-3.6V（4.2V 滿電時略超規格，但實測通常沒問題）

### 步驟 4: 分壓電路（電量偵測）

```
TP4056 OUT+ ─┬─ 100kΩ ─┬─ 33kΩ ─┬─ GND
             │          └───────> A0
             │
             └─> (供電至 ESP8266 3.3V)
```

### 步驟 5: 充電狀態檢測（可選）

```
TP4056 CHRG  ─> ESP8266 GPIO14 (D5)
TP4056 STDBY ─> ESP8266 GPIO12 (D6)
```

---

## 📐 完整接線示意圖

```
                  ┌───────────────┐
                  │ USB 充電器 5V │
                  └───┬───────┬───┘
                      │       │
    ┌─────────────────┘       └─────────────────┐
    │                                            │
    │  ┌──────────────────────┐                 │
    │  │   TP4056 充電模組    │                 │
    │  │   (含保護板 DW01A)   │                 │
    │  │                      │                 │
    ├─>│ IN+            OUT+ ─┼─────┬───────────┼──> ESP8266 3.3V 腳位
    │  │                  │   │     │           │
    └─>│ IN-            OUT- ─┼─────┼───────────┼──> ESP8266 GND
       │                  │   │     │           │
       │ B+             CHRG ─┼─────┼───────────┼──> GPIO14 (D5)
       │  │                   │     │           │
       │ B-            STDBY ─┼─────┼───────────┼──> GPIO12 (D6)
       │  │                   │     │           │
       └──┼───────────────────┘     │           │
          │                         │           │
    ┌─────┴──────┐                  │           │
    │ 18650 電池 │                  │           │
    │ 3.7V 帶保護│                  │           │
    │            │                  │           │
    │   (+) ─────┼──────────────────┘           │
    │   (-) ─────┼──────────────────────────────┘
    └────────────┘                  │
                                    │
                      分壓電路      │
                      ┌─────────────┘
                      │
                      ├─ 100kΩ ─┬─ 33kΩ ─┬─ GND
                      │          └────────┼──> A0
                      │                   │
                      └───────────────────┘


    ┌─────────────────────────────────────┐
    │      ESP8266 (WeMos D1 Mini)        │
    │                                     │
    │  3.3V ◄──────────── TP4056 OUT+    │
    │  GND  ◄──────────── TP4056 OUT-    │
    │  A0   ◄──────────── 分壓電路       │
    │  D5   ◄──────────── TP4056 CHRG    │
    │  D6   ◄──────────── TP4056 STDBY   │
    │  D0   ◄──┐                          │
    │  RST  ◄──┘ (Deep Sleep 喚醒)       │
    │                                     │
    │  USB  ◄──────────── USB 線（程式上傳）│
    │                                     │
    └─────────────────────────────────────┘
```

---

## ⚠️ 重要注意事項

### 1. 電壓範圍問題

ESP8266 **官方規格**:
- 工作電壓: **3.0V - 3.6V**
- 推薦電壓: **3.3V**

電池電壓範圍:
- 滿電: 4.2V（**超出規格** +0.6V）
- 正常: 3.7V（符合規格）
- 低電量: 3.0V（規格下限）

**解決方案**:
1. **使用低壓差 LDO**（推薦）:
   - 在 TP4056 OUT+ 與 ESP8266 3.3V 之間加 **MCP1700-3.3** 或 **HT7333**
   - 輸入範圍: 3.2-16V → 輸出穩定 3.3V
   - 靜態電流: < 10µA（Deep Sleep 影響小）
   - 成本: NT$5-10

   ```
   TP4056 OUT+ ──> [MCP1700-3.3] ──> ESP8266 3.3V
                        │
                       GND
   ```

2. **軟體保護**（次選）:
   - 監控電池電壓，> 4.0V 時限制 WiFi TX Power
   - 充滿時（4.2V）避免長時間高負載
   - 多數 ESP8266 能容忍短時間 4.2V（但不建議長期）

### 2. 充電時的電流分配

充電時可能發生：
- TP4056 充電電流 1A
- ESP8266 運行電流 ~200mA（WiFi 傳輸時）
- 總電流需求 > USB 供電能力（500mA - 2A）

**解決方案**:
1. 使用 **2A 充電器**（推薦 5V/2A）
2. 充電時降低 ESP8266 活動（延長休眠間隔）
3. 確認 TP4056 的 Rprog 電阻（1.2kΩ = 1A，可改為 2kΩ = 500mA 降低負擔）

### 3. USB 共用問題

若希望單一 USB 線同時充電 + 程式上傳：
- 需在 ESP8266 USB 5V 與 TP4056 IN+ 之間加 **1N5819 蕭特基二極體**（防倒灌）
- 或使用**理想二極體**（TPS2111）自動切換

**簡化方案**:
- 充電與程式上傳用不同 USB 線（推薦原型開發）

---

## 🧪 測試與驗證

### 測試 1: 電壓範圍測試

1. 充滿電池至 4.2V
2. 接上 ESP8266（不加 LDO）
3. 用萬用表測量 3.3V 腳位電壓
4. 上傳簡單程式測試穩定性

**預期結果**:
- 3.3V 腳位實測 ≈ 電池電壓（3.0-4.2V）
- ESP8266 正常開機（可能在 4.2V 時略高）

**若加 LDO**:
- 3.3V 腳位穩定在 3.30V ±0.05V

### 測試 2: 充電測試

1. 插入 USB 充電器至 TP4056
2. 觀察紅燈亮起（充電中）
3. 用萬用表測量充電電流
4. 充滿後藍/綠燈亮起

**預期結果**:
- 充電電流 500mA - 1A（視 Rprog 電阻）
- 充滿時間 2-3 小時（2600mAh 電池）

### 測試 3: 同時充電與運行

1. USB 充電線接 TP4056
2. ESP8266 運行（WiFi 連接 + 顯示更新）
3. 觀察是否穩定

**預期結果**:
- 邊充邊用正常運作
- 充電器需 2A 以上

---

## 📊 方案比較

| 項目 | 方案 A<br>(外部 TP4056+MT3608) | 方案 B1<br>(板載充電電路) | 方案 B2<br>(外部 TP4056 接 3.3V) | 方案 B2+LDO<br>(**推薦**) |
|------|------|------|------|------|
| 硬體複雜度 | 高（3 模組）| 低（0 模組）| 中（1 模組）| 中（1 模組 + LDO）|
| 成本 | NT$130 | NT$80 | NT$107 | NT$115 |
| 體積 | 大 | 最小 | 小 | 小 |
| 電壓穩定 | 極佳（5V 輸入）| 佳 | 普通（3.0-4.2V）| 極佳（LDO 穩壓）|
| 相容性 | 全部開發板 | 限特定板子 | 全部開發板 | 全部開發板 |
| 安全性 | 高 | 高（原廠設計）| 中（需監控電壓）| 高（LDO 保護）|
| 推薦度 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**結論**:
- 若你的開發板有 BAT 接口 → 用 **方案 B1**（最簡單）
- 若標準 WeMos D1 Mini → 用 **方案 B2+LDO**（最佳平衡）

---

## 🛠️ 更新的 BOM 表（方案 B2+LDO）

| 項目 | 型號/規格 | 數量 | 單價 (NT$) | 備註 |
|------|----------|------|-----------|------|
| 鋰電池 | 18650 2600mAh (帶保護板) | 1 | 80 | 必須帶保護板 |
| TP4056 模組 | 微型版 含保護 | 1 | 20 | 17×12mm |
| LDO 穩壓 | MCP1700-3.3 或 HT7333 | 1 | 10 | SOT-23 或 TO-92 |
| 電容 | 1µF 陶瓷（LDO 輸出）| 1 | 2 | 穩定 LDO |
| 電阻 | 100kΩ | 1 | 1 | 分壓 |
| 電阻 | 33kΩ | 1 | 1 | 分壓 |
| 杜邦線 | 母對母 | 5 | 5 | |
| **總計** | | | **119** | |

---

## 🔄 與方案 A 的整合

本文件作為 `HARDWARE_ARCHITECTURE.md` 的補充方案，你可以：
1. 先閱讀方案 A（完整架構理解）
2. 根據你的開發板選擇方案 B1 或 B2
3. 軟體架構（`SOFTWARE_ARCHITECTURE.md`）完全通用

---

## 📚 延伸閱讀

- [MCP1700 Datasheet](https://ww1.microchip.com/downloads/en/DeviceDoc/20001826D.pdf)
- [ESP8266 Hardware Design Guidelines](https://www.espressif.com/sites/default/files/documentation/esp8266_hardware_design_guidelines_en.pdf)
- [TP4056 Application Notes](https://www.electrodragon.com/w/images/6/6a/TP4056.pdf)

---

**版本**: 1.0  
**撰寫日期**: 2025-10-12  
**維護**: battery_management 專案團隊
