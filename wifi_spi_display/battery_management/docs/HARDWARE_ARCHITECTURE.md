# 電池供電與充放電管理 - 硬體架構設計

本文件說明為 ESP8266 電子紙顯示系統加入電池供電與充放電管理的硬體架構與選型方案。

---

## 🎯 設計目標

- **供電穩定**: 提供穩定的 3.3V 給 ESP8266 與 E-Paper
- **長續航**: 支援 Deep Sleep 模式，目標單次充電運行 7+ 天（每日更新 1-2 次）
- **充電安全**: 具備過充/過放/短路保護
- **狀態可視**: 可透過 GPIO 或 ADC 偵測電池電量與充電狀態
- **成本控制**: 使用常見模組，單套 BOM 成本 < NT$200

---

## 📊 系統架構圖

```
USB 5V ─┬─> [充電模組 TP4056] ─┬─> [保護板 DW01A] ─┬─> [升壓模組 MT3608] ─> 5V ─> [LDO AMS1117-3.3] ─> 3.3V ─┬─> ESP8266
        │                      │                    │                                                           │
        │                      │                    │                                                           └─> E-Paper
        │                      │                    │
        └─> [CHRG/STDBY]       └─> [鋰電池 18650]   └─> [ADC 分壓電路] ─> GPIO(A0)
             充電指示                3.7V 2000-3000mAh      電量偵測
```

**供電流向**:
1. USB 充電時: USB 5V → TP4056 → 電池充電 + 同步供電給升壓模組
2. 電池供電時: 電池 3.7V → 保護板 → 升壓至 5V → LDO 降至 3.3V → ESP8266

---

## 🔌 硬體模組選型與規格

### 1. 電池選型

#### 方案 A: 18650 鋰電池（推薦）

| 項目 | 規格 |
|------|------|
| 型號 | Samsung ICR18650-26F / Panasonic NCR18650B |
| 電壓 | 標稱 3.7V，充電截止 4.2V，放電截止 2.75V |
| 容量 | 2600mAh - 3400mAh |
| 優點 | 容量大、價格低、易取得、支援大電流 |
| 缺點 | 體積較大（Ø18×65mm）|
| 價格 | NT$50-100/顆 |

#### 方案 B: 鋰聚合物電池（可選）

| 項目 | 規格 |
|------|------|
| 型號 | 103450 / 103040 |
| 電壓 | 3.7V |
| 容量 | 1500mAh - 2000mAh |
| 優點 | 體積小、形狀可客製、輕量 |
| 缺點 | 價格稍高、需注意膨脹風險 |
| 價格 | NT$80-150 |

**建議**: 原型開發用 **18650**（容量大、測試穩定），量產或體積敏感場景用鋰聚。

---

### 2. 充電管理 IC

#### 推薦: TP4056 模組

| 項目 | 規格 |
|------|------|
| 型號 | TP4056 + DW01A 保護板（二合一模組）|
| 輸入電壓 | 4.5V - 5.5V（USB 供電）|
| 充電電流 | 可調（1000mA，透過 Rprog 電阻）|
| 充電截止 | 4.2V ±1% |
| 狀態指示 | CHRG（充電中，紅燈），STDBY（充滿，藍/綠燈）|
| 保護功能 | 過充、過放、過流、短路（DW01A）|
| 尺寸 | 26×17mm（含保護板）|
| 價格 | NT$15-30 |

**接腳定義**:
```
IN+/IN-  : USB 5V 輸入
OUT+/OUT-: 電池輸出（已含保護）
B+/B-    : 電池連接
```

**優點**:
- 整合充電 + 保護，一片搞定
- 可邊充邊用（Pass-through）
- 指示燈直觀

**替代方案**: MCP73831（體積更小，但需外加保護 IC）

---

### 3. 升壓模組

#### 推薦: MT3608 DC-DC 升壓模組

| 項目 | 規格 |
|------|------|
| 輸入電壓 | 2V - 24V（電池 2.75-4.2V 可用）|
| 輸出電壓 | 可調 5V - 28V（預設或透過電位器調至 5V）|
| 輸出電流 | 最大 2A（效率 >93%）|
| 效率 | 93% @ 5V 500mA |
| 尺寸 | 36×17mm |
| 價格 | NT$10-20 |

**為何需要升壓？**
- ESP8266 標準供電 5V（透過板載 AMS1117 降至 3.3V）
- 電池電壓 2.75-4.2V 不足，需升壓至穩定 5V

**替代方案**:
- **直接 3.3V 供電**（進階）: 使用 TPS61070/MCP1640 升壓至 3.3V，繞過 AMS1117，降低損耗。但需改裝 WeMos D1 Mini（移除板載 LDO）。

---

### 4. 電量偵測電路

#### ADC 分壓電路

ESP8266 的 A0（ADC）輸入範圍 **0-1V**，需透過分壓電路將電池電壓（2.75-4.2V）降至安全範圍。

**電路設計**:
```
電池+ ─┬─ R1 (100kΩ) ─┬─ R2 (33kΩ) ─┬─ GND
       │               │              │
       │               └─> A0 (ESP8266)
       │
      (4.2V max)       (0.97V max)
```

**分壓比計算**:
- 總電阻: R1 + R2 = 133kΩ
- 4.2V × (33kΩ / 133kΩ) = **1.04V**（略超，安全範圍內）
- 2.75V × (33kΩ / 133kΩ) = **0.68V**

**ADC 讀值對應**:
- ADC 範圍: 0-1023（10-bit）
- 電池 4.2V → ADC ≈ 1023
- 電池 3.7V → ADC ≈ 900
- 電池 3.0V → ADC ≈ 730（低電量警告）
- 電池 2.75V → ADC ≈ 670（關機閾值）

**程式碼範例**:
```cpp
float readBatteryVoltage() {
    int adcValue = analogRead(A0);
    float voltage = adcValue * (4.2 / 1023.0); // 校正係數
    return voltage;
}
```

**替代方案**: 使用 INA219 電流/電壓監測模組（I2C），精度更高但成本增加。

---

### 5. 充電狀態偵測

透過 GPIO 讀取 TP4056 的 CHRG/STDBY 腳位狀態。

| TP4056 狀態 | CHRG | STDBY | 說明 |
|------------|------|-------|------|
| 未充電 | HIGH | HIGH | 無 USB 輸入 |
| 充電中 | LOW | HIGH | 紅燈亮 |
| 充滿 | HIGH | LOW | 藍/綠燈亮 |

**接線**:
```
TP4056 CHRG ─> ESP8266 GPIO14 (D5)
TP4056 STDBY ─> ESP8266 GPIO12 (D6)
```

**程式碼範例**:
```cpp
#define PIN_CHRG  14  // D5
#define PIN_STDBY 12  // D6

void checkChargeStatus() {
    pinMode(PIN_CHRG, INPUT_PULLUP);
    pinMode(PIN_STDBY, INPUT_PULLUP);
    
    bool charging = (digitalRead(PIN_CHRG) == LOW);
    bool full = (digitalRead(PIN_STDBY) == LOW);
    
    if (charging) {
        Serial.println("充電中...");
    } else if (full) {
        Serial.println("充電完成");
    } else {
        Serial.println("電池供電中");
    }
}
```

---

## 🔧 完整硬體 BOM 表

| 項目 | 型號/規格 | 數量 | 單價 (NT$) | 小計 |
|------|----------|------|-----------|------|
| 鋰電池 | 18650 2600mAh | 1 | 70 | 70 |
| 充電模組 | TP4056 + 保護板 | 1 | 20 | 20 |
| 升壓模組 | MT3608 (5V) | 1 | 15 | 15 |
| 電阻 | 100kΩ 1/4W | 1 | 1 | 1 |
| 電阻 | 33kΩ 1/4W | 1 | 1 | 1 |
| 電池座 | 18650 單節 | 1 | 10 | 10 |
| 杜邦線/排針 | - | 若干 | 10 | 10 |
| **總計** | | | | **127** |

> 不含 ESP8266、E-Paper 本體成本。

---

## 🛠️ 組裝接線指南

### 接線步驟

1. **電池連接 TP4056**
   ```
   18650 正極 → TP4056 B+
   18650 負極 → TP4056 B-
   ```

2. **USB 充電輸入**
   ```
   USB 5V → TP4056 IN+
   USB GND → TP4056 IN-
   ```

3. **TP4056 輸出至升壓模組**
   ```
   TP4056 OUT+ → MT3608 IN+
   TP4056 OUT- → MT3608 IN-
   ```

4. **升壓模組輸出至 ESP8266**
   ```
   MT3608 OUT+ (5V) → WeMos D1 Mini 5V 腳位
   MT3608 OUT- (GND) → WeMos D1 Mini GND
   ```

5. **電量偵測分壓電路**
   ```
   TP4056 OUT+ ─┬─ R1(100kΩ) ─┬─ R2(33kΩ) ─┬─ GND
                │               └─> A0       │
                │                             │
                └─────────────────────────────┘
   ```

6. **充電狀態偵測（可選）**
   ```
   TP4056 CHRG → GPIO14 (D5)
   TP4056 STDBY → GPIO12 (D6)
   ```

### 接線示意圖（ASCII Art）

```
        USB 5V Input
             │
    ┌────────┴─────────┐
    │   TP4056 Module  │
    │  (Charge + BMS)  │
    │                  │
    │  B+         OUT+ │───┬───> [MT3608 升壓] ───> 5V ───> ESP8266 (5V Pin)
    │  │           │   │   │         IN+   OUT+              │
    │  │           │   │   │                                 GND
    │  B-         OUT- │───┴────────> GND ──────────────────┘
    │                  │   │
    │  CHRG  STDBY     │   └─> [分壓電路] ─> A0 (ADC)
    └──┬──────┬────────┘
       │      │
    GPIO14  GPIO12
     (D5)    (D6)
       │      │
    [18650 電池]
     3.7V 2600mAh
```

---

## ⚡ 功耗估算與續航預測

### ESP8266 各模式功耗

| 模式 | 功耗 | 說明 |
|------|------|------|
| Active (WiFi TX) | ~170mA @ 3.3V | WiFi 傳輸 |
| Active (WiFi RX) | ~60mA @ 3.3V | WiFi 接收 |
| Modem Sleep | ~15mA | CPU 運作，WiFi 關閉 |
| Light Sleep | ~0.9mA | CPU 暫停，可快速喚醒 |
| Deep Sleep | ~20µA (0.02mA) | 最低功耗，需 RST 喚醒 |

### E-Paper 顯示功耗

| 階段 | 功耗 | 時間 |
|------|------|------|
| 待機 | ~1µA | 長時間 |
| 更新中 | ~40mA @ 3.3V | ~3-5 秒 |

### 典型使用場景

**場景**: 每天早上 8:00 更新一次天氣資訊，其餘時間 Deep Sleep

**單次更新流程**:
1. Deep Sleep 喚醒: ~1 秒
2. WiFi 連接: ~2 秒 @ 100mA
3. WebSocket 接收圖像: ~5 秒 @ 60mA
4. E-Paper 更新: ~4 秒 @ 40mA
5. 進入 Deep Sleep: ~0.02mA

**每日耗電量計算**:
```
WiFi 連接:     2s × 100mA = 200mA·s = 0.056mAh
資料接收:      5s × 60mA  = 300mA·s = 0.083mAh
顯示更新:      4s × 40mA  = 160mA·s = 0.044mAh
Deep Sleep:    86400s × 0.02mA = 1728mA·s = 0.48mAh
─────────────────────────────────────────────
每日總計:      ≈ 0.66mAh
```

**續航時間** (2600mAh 電池):
```
2600mAh ÷ 0.66mAh/天 ≈ 3939 天（理論值）
```

**實際續航** (考慮 20% 系統損耗 + 電池保護):
```
2600mAh × 0.8 ÷ 0.66mAh/天 ≈ 3151 天
實際可用範圍（2.75-4.0V）約 80% 容量
最終續航: ~60-90 天（極低頻更新）
```

**高頻更新場景** (每小時更新一次):
```
每日更新 24 次: 0.66mAh × 24 = 15.84mAh/天
續航: 2600mAh × 0.8 ÷ 15.84mAh ≈ 131 天
```

---

## 🔒 安全保護機制

### 1. 電池保護板功能（DW01A）

- **過充保護**: 電壓 > 4.25V 時切斷充電
- **過放保護**: 電壓 < 2.4V 時切斷輸出
- **過流保護**: 電流 > 3A 時切斷
- **短路保護**: 瞬間大電流觸發

### 2. 軟體保護（需韌體實作）

- **低電量警告**: 電壓 < 3.2V 時透過 Server 推送警告
- **自動關機**: 電壓 < 3.0V 時進入 Deep Sleep 並停止喚醒
- **充電檢測**: 偵測到充電時降低喚醒頻率

### 3. 物理保護

- **電池絕緣**: 使用電池座，避免短路
- **散熱**: 充電模組遠離 ESP8266，避免熱干擾
- **固定**: 電池與模組牢固固定，防止移動接觸不良

---

## 📐 PCB 設計建議（進階）

若要整合成單一 PCB，建議佈局：

1. **電源區域隔離**: 高電流路徑（充電、升壓）與低噪聲區域（ESP8266、ADC）分開
2. **地線設計**: 數位地、類比地、電源地在單點星形連接
3. **過孔**: 電源線使用多個過孔降低阻抗
4. **去耦電容**: 每個 IC 旁加 100nF 陶瓷電容 + 10µF 電解電容
5. **天線區域**: ESP8266 天線下方保持淨空（no copper pour）

---

## 🔄 升級路徑

### 短期（原型驗證）
- 使用模組化方案（TP4056 + MT3608）
- 麵包板或洞洞板接線
- 測試功耗與續航

### 中期（小批量）
- 整合 PCB 設計，減少體積
- 加入電量顯示 LED（3 段式：綠/黃/紅）
- 考慮太陽能充電擴充接口

### 長期（量產）
- 改用 MCP73831 + TPS61070（更小體積）
- ESP32-C3（更低功耗 + 支援 BLE）
- 加入無線充電（Qi）

---

## 📚 參考資料

- [TP4056 Datasheet](https://www.electrodragon.com/w/images/6/6a/TP4056.pdf)
- [MT3608 Datasheet](https://www.olimex.com/Products/Breadboarding/BB-PWR-3608/resources/MT3608.pdf)
- [ESP8266 Low Power Solutions](https://www.espressif.com/sites/default/files/9b-esp8266-low_power_solutions_en_0.pdf)
- [DW01A Protection IC](https://www.ic-fortune.com/upload/Download/DW01A-DS-12_EN.pdf)

---

**版本**: 1.0  
**撰寫日期**: 2025-10-12  
**維護**: battery_management 專案團隊
