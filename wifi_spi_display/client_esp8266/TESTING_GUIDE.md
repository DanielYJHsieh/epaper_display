# 記憶體優化版本測試指南

## 📋 版本資訊
- **版本號**：v1.1
- **發布日期**：2024-10-06
- **主要更新**：記憶體碎片化智能處理

## 🎯 期望的新行為

### **正常情況（記憶體充足）**
```
*** 嘗試分配顯示緩衝區（完整更新）***
分配前 - 可用: 48304 bytes, 最大塊: 48000 bytes
*** 分配成功，分配後可用: 300 bytes ***
解壓縮中...
解壓縮完成: XXX ms
更新顯示中...
```

### **記憶體碎片化情況（自動降級）**
```
*** 嘗試分配顯示緩衝區（完整更新）***
分配前 - 可用: 48304 bytes, 最大塊: 47680 bytes
*** 最大塊不足，切換到純分塊模式 ***
需要: 48000 bytes, 最大塊: 47680 bytes
*** 切換到純分塊處理模式 ***
*** 使用純分塊處理模式 ***
*** 警告：純分塊模式尚未完全實作 ***
*** 建議：重啟 ESP8266 以獲得更多連續記憶體 ***
*** 顯示白屏作為降級處理 ***
*** 純分塊處理完成 ***
總耗時: XXX ms
發送 ACK: SeqID=X
```

## ✅ 驗證檢查清單

### **1. 啟動檢查**
- [ ] 看到 "WiFi SPI Display - Client v1.1"
- [ ] 看到 "記憶體優化版 2024-10-06"
- [ ] 看到 "*** 嘗試整理記憶體碎片 ***"
- [ ] 記憶體整理前後數據正確顯示

### **2. 記憶體監控**
- [ ] 定期顯示記憶體狀況（每 10 秒）
- [ ] 顯示：可用記憶體、最大塊、碎片化百分比
- [ ] 當最大塊 < 48KB 時，顯示 "提示：使用純分塊模式"
- [ ] 不再顯示誤導性的 "警告：無法分配完整顯示緩衝！"

### **3. 影像更新處理**
- [ ] 嘗試動態分配完整緩衝區
- [ ] 分配失敗時自動切換到純分塊模式
- [ ] 發送 ACK 而非 NAK
- [ ] 不會中斷連接

### **4. 錯誤處理**
- [ ] 記憶體不足時優雅降級
- [ ] 顯示清楚的狀態訊息
- [ ] 提供建議（如：重啟整理記憶體）

## 🧪 測試步驟

### **測試 1：正常啟動**
1. 重置 ESP8266
2. 檢查序列埠輸出
3. 確認版本號為 v1.1
4. 確認記憶體整理執行

**預期結果**：
```
WiFi SPI Display - Client v1.1
=== 記憶體優化版 2024-10-06 ===
*** 嘗試整理記憶體碎片 ***
整理前 - 可用: XXXXX bytes, 最大塊: XXXXX bytes
整理後 - 可用: XXXXX bytes, 最大塊: XXXXX bytes
```

### **測試 2：記憶體碎片化處理**
1. 啟動 server：`python server.py`
2. 發送影像到 ESP8266
3. 觀察序列埠輸出

**預期結果**：
- 如果記憶體充足：正常顯示影像
- 如果記憶體碎片化：切換到純分塊模式，顯示白屏
- 在兩種情況下都發送 ACK
- 不會發送 NAK 並中斷連接

### **測試 3：持續運作**
1. 連續發送多張影像
2. 觀察記憶體狀況變化
3. 確認系統持續運作

**預期結果**：
- 記憶體狀況定期報告
- 即使碎片化也能繼續運作
- 不會出現 "發送 NAK" 訊息

## 📊 記憶體狀況解讀

### **狀況 1：理想狀態**
```
記憶體狀況 - 可用: 48304 bytes, 最大塊: 48100 bytes, 碎片化: 0%
```
- ✅ 可以分配完整緩衝區
- ✅ 正常顯示模式

### **狀況 2：輕度碎片化**
```
記憶體狀況 - 可用: 48304 bytes, 最大塊: 47680 bytes, 碎片化: 1%
*** 提示：使用純分塊模式（記憶體碎片化） ***
```
- ⚠️ 無法分配完整緩衝區
- ✅ 自動切換到純分塊模式
- ✅ 顯示白屏作為降級處理

### **狀況 3：嚴重碎片化**
```
記憶體狀況 - 可用: 48304 bytes, 最大塊: 5000 bytes, 碎片化: 89%
*** 嚴重警告：連分塊緩衝都無法分配！***
*** 建議立即重啟以整理記憶體 ***
```
- ❌ 連小塊都無法分配
- ⚠️ 建議重啟 ESP8266

## 🔧 故障排除

### **問題 1：仍然看到舊版本訊息**
**症狀**：
```
WiFi SPI Display - Client v1.0
*** 錯誤：無法分配顯示緩衝！***
發送 NAK: SeqID=1
```

**解決方案**：
1. 確認已編譯最新版本
2. 重新燒錄韌體
3. 硬體重置 ESP8266

**驗證命令**：
```bash
arduino-cli compile --fqbn esp8266:esp8266:d1_mini client_esp8266.ino
arduino-cli upload --fqbn esp8266:esp8266:d1_mini --port COM5 client_esp8266.ino
```

### **問題 2：記憶體持續碎片化**
**症狀**：
- 碎片化百分比持續上升
- 頻繁進入純分塊模式

**解決方案**：
1. 重啟 ESP8266
2. 減少其他功能的記憶體使用
3. 考慮減少 WebSocket 緩衝區大小

### **問題 3：無法連接 WiFi**
**症狀**：
- 看到 "連線 WiFi..." 但無法連接

**檢查**：
1. config.h 中的 WiFi SSID 和密碼
2. WiFi 訊號強度
3. 路由器設定

## 📝 測試記錄範本

```
測試日期：__________
測試者：__________

✅ 啟動測試
  - 版本號：v1.1
  - 記憶體整理：成功
  - 初始可用記憶體：______ bytes

✅ 功能測試
  - 影像顯示：□ 正常模式 □ 分塊模式
  - 記憶體狀況：______ bytes (最大塊: ______ bytes)
  - 碎片化：_____%

✅ 穩定性測試
  - 連續運作時間：______ 分鐘
  - 處理影像數量：______ 張
  - 錯誤次數：______

備註：
_________________________________
_________________________________
```

---

**重要提示**：
- 第一次使用請執行 `flash.bat` 進行燒錄
- 測試時請監控序列埠輸出（115200 baud）
- 如遇問題請記錄完整的序列埠輸出