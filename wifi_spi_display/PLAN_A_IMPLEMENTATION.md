# ğŸ¯ æ–¹æ¡ˆ A å¯¦æ–½å®Œæˆ - 3-Tile æ°´å¹³åˆ†å‰²

**Date**: 2024-10-10  
**Version**: v1.7.0  
**Type**: Optimization - Reduced Tile Count  
**Status**: âœ… Ready for Testing

---

## ğŸ“‹ å¯¦æ–½ç¸½çµ

æˆåŠŸå°‡åˆ†å€æ•¸é‡å¾ **4 å€‹ (400Ã—240)** å„ªåŒ–ç‚º **3 å€‹ (800Ã—160)**ï¼Œå¯¦ç¾æ°´å¹³åˆ†å‰²æ–¹æ¡ˆ Aã€‚

---

## ğŸ¯ æ–¹æ¡ˆ A è¦æ ¼

### åˆ†å€é…ç½®
```
ç¸½è¢å¹•: 800Ã—480
åˆ†å€æ–¹å¼: æ°´å¹³åˆ†å‰²ï¼ˆ3 å€‹æ¢ç‹€ï¼‰
æ¯åˆ†å€: 800Ã—160 pixels

åˆ†å€æ’åˆ—:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tile 0: ä¸Šæ–¹ (0,0)        â”‚ 800Ã—160
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Tile 1: ä¸­é–“ (0,160)      â”‚ 800Ã—160  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Tile 2: ä¸‹æ–¹ (0,320)      â”‚ 800Ã—160
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¨˜æ†¶é«”ä½¿ç”¨
```
æ¯åˆ†å€ç·©è¡: 16,000 bytes (800Ã—160Ã·8)
ç¸½ RAM ä½¿ç”¨: 30,484 bytes (38%)
åˆ†å€ç·©è¡å€: 16KB (é å…ˆé…ç½®)
å¯ç”¨è¨˜æ†¶é«”: ~7KB (è¶³å¤ )
æœ€å¤§é€£çºŒå¡Š: é è¨ˆ ~20KB
```

---

## ğŸ“Š å°æ¯”åˆ†æ

| é …ç›® | v1.6.4 (4 tiles) | v1.7.0 (3 tiles) | æ”¹å–„ |
|------|------------------|------------------|------|
| **é…ç½®** |
| åˆ†å€æ•¸é‡ | 4 | 3 | **-25%** âœ… |
| åˆ†å€å°ºå¯¸ | 400Ã—240 | 800Ã—160 | - |
| åˆ†å€æ–¹å¼ | 2Ã—2 ç¶²æ ¼ | æ°´å¹³æ¢ç‹€ | æ›´ç°¡å–® |
| **è¨˜æ†¶é«”** |
| æ¯åˆ†å€ | 12KB | 16KB | +33% |
| å¯ç”¨é¤˜é‡ | ~11KB | ~7KB | ä»å®‰å…¨ âœ… |
| å³°å€¼ä½¿ç”¨ | 12KB | 16KB | +4KB |
| **æ€§èƒ½** |
| æ›´æ–°æ™‚é–“ | ~80s | **~60s** | **-25%** âœ… |
| å‚³è¼¸æ¬¡æ•¸ | 4 | 3 | **-25%** âœ… |
| æ¯æ¬¡æ™‚é–“ | ~18s | ~18s | ç›¸åŒ |

---

## ğŸ”§ å¯¦æ–½è®Šæ›´

### ESP8266 ç«¯ (Client)

#### 1. config.h
```cpp
// æ–¹æ¡ˆ A: 3 æ¬¡æ°´å¹³åˆ†å‰² (800Ã—160 per tile)
#define TILE_COUNT 3                 // åˆ†å€æ•¸é‡ï¼ˆ3 å€‹æ°´å¹³åˆ†å€ï¼‰
#define TILE_WIDTH 800               // åˆ†å€å¯¬åº¦ï¼ˆå…¨è¢å¹•å¯¬åº¦ï¼‰
#define TILE_HEIGHT 160              // åˆ†å€é«˜åº¦ï¼ˆ480Ã·3=160ï¼‰
#define TILE_BUFFER_SIZE 16000       // 16KB per tile
```

#### 2. protocol.h
```cpp
// åˆ†å€ç´¢å¼•å®šç¾©ï¼ˆæ–¹æ¡ˆ Aï¼š3 å€‹æ°´å¹³åˆ†å€ï¼‰
#define TILE_INDEX_TOP          0  // ä¸Šæ–¹å€åŸŸ (0, 0, 800, 160)
#define TILE_INDEX_MIDDLE       1  // ä¸­é–“å€åŸŸ (0, 160, 800, 320)
#define TILE_INDEX_BOTTOM       2  // ä¸‹æ–¹å€åŸŸ (0, 320, 800, 480)
#ifndef TILE_COUNT
#define TILE_COUNT              3  // ç¸½å€åŸŸæ•¸
#endif
```

#### 3. client_esp8266.ino
```cpp
// åº§æ¨™è¨ˆç®—ï¼ˆæ°´å¹³åˆ†å‰²ï¼‰
uint16_t tile_x = 0;
uint16_t tile_y = tileIndex * TILE_HEIGHT;  // 0, 160, 320

const char* tileNames[] = {"ä¸Šæ–¹", "ä¸­é–“", "ä¸‹æ–¹"};

// é›¶æ‹·è²ä¿®å¾©
uint8_t* originalPayload = payload;  // ä¿å­˜åŸå§‹æŒ‡æ¨™
// ... payload++ å¾Œ ...
bool isExternalBuffer = (originalPayload == tileBuffer);  // ä½¿ç”¨åŸå§‹æŒ‡æ¨™æª¢æ¸¬
```

### Server ç«¯ (Python)

#### 1. image_processor.py
```python
def split_image_to_tiles(self, image: Image.Image) -> dict:
    """3 å€‹æ°´å¹³å€å¡Š (800Ã—160)"""
    # ä¸Šæ–¹ (0, 0, 800, 160)
    tiles[0] = image.crop((0, 0, 800, 160))
    # ä¸­é–“ (0, 160, 800, 320)
    tiles[1] = image.crop((0, 160, 800, 320))
    # ä¸‹æ–¹ (0, 320, 800, 480)
    tiles[2] = image.crop((0, 320, 800, 480))
    return tiles

def process_tile(self, tile: Image.Image) -> bytes:
    """è™•ç† 800Ã—160 å€å¡Š -> 16000 bytes"""
    if tile.size != (800, 160):
        tile = tile.resize((800, 160))
    return self.image_to_bytes(tile)
```

#### 2. server.py
```python
# åˆ†å‰²æˆ 3 å€‹å€å¡Š
tiles = self.processor_800.split_image_to_tiles(processed)
tile_names = ["ä¸Šæ–¹", "ä¸­é–“", "ä¸‹æ–¹"]

# ä¾åºç™¼é€ 3 å€‹å€å¡Š
for tile_index in range(3):
    # ... è™•ç†ä¸¦ç™¼é€ ...
```

---

## ğŸ› é‡è¦ä¿®å¾©ï¼šé›¶æ‹·è²å•é¡Œ

### å•é¡Œè¨ºæ–·
```
åŸå§‹ log:
âœ“ ä½¿ç”¨å¤–éƒ¨ç·©è¡å€: 12001 bytes       â† PacketReceiver è¨­ç½®äº†å¤–éƒ¨ç·©è¡å€
âš ï¸ Payload ä½¿ç”¨å…§éƒ¨ç·©è¡å€ï¼ˆéœ€è¦è¤‡è£½ï¼‰ â† ä½†é›¶æ‹·è²æª¢æ¸¬å¤±æ•—ï¼
```

### æ ¹æœ¬åŸå› 
```cpp
// å•é¡Œä»£ç¢¼
uint8_t tileIndex = payload[0];
payload++;  // âŒ é€™è¡Œæ”¹è®Šäº†æŒ‡æ¨™ï¼
// ...
bool isExternalBuffer = (payload == tileBuffer);  // âŒ æª¢æ¸¬å¤±æ•—
```

**åˆ†æ**: 
- `payload++` å°‡æŒ‡æ¨™å‘å‰ç§»å‹• 1 byte
- å°è‡´ `payload != tileBuffer` å³ä½¿åŸå§‹æŒ‡æ¨™æ˜¯ tileBuffer
- é›¶æ‹·è²æª¢æ¸¬å¤±æ•—ï¼Œè§¸ç™¼ä¸å¿…è¦çš„ memcpy

### è§£æ±ºæ–¹æ¡ˆ
```cpp
// ä¿®å¾©ä»£ç¢¼
uint8_t* originalPayload = payload;  // âœ… ä¿å­˜åŸå§‹æŒ‡æ¨™
uint8_t tileIndex = payload[0];
payload++;  // è·³é tile_index
// ...
bool isExternalBuffer = (originalPayload == tileBuffer);  // âœ… ä½¿ç”¨åŸå§‹æŒ‡æ¨™

if (isExternalBuffer) {
    // é›¶æ‹·è²æ¨¡å¼ï¼šä½¿ç”¨ memmove ç§»é™¤ç¬¬ä¸€å€‹ byte
    memmove(tileBuffer, tileBuffer + 1, length);
    decompressedSize = length;
}
```

**æ•ˆæœ**:
- âœ… é›¶æ‹·è²æª¢æ¸¬æ­£å¸¸å·¥ä½œ
- âœ… çœŸæ­£å¯¦ç¾é›¶æ‹·è² (payload ç›´æ¥ä½¿ç”¨ tileBuffer)
- âœ… è¨˜æ†¶é«”ä½¿ç”¨æœ€å„ªåŒ–

---

## ğŸ“Š é æœŸæ•ˆæœ

### è¨˜æ†¶é«”ä½¿ç”¨ (ç·¨è­¯çµæœ)
```
RAM Usage: 30,484 / 80,192 bytes (38%)
IRAM Usage: 60,737 / 65,536 bytes (92%)
Flash Usage: 379,704 / 1,048,576 bytes (36%)

âœ… èˆ‡ v1.6.4 å®Œå…¨ç›¸åŒ (å„ªç§€çš„è¨˜æ†¶é«”æ•ˆç‡)
```

### é‹è¡Œæ™‚è¨˜æ†¶é«”
```
å•Ÿå‹•å¾Œå¯ç”¨: ~24KB
åˆ†å€ç·©è¡: 16KB
è™•ç†æ™‚å¯ç”¨: ~7-8KB
é›¶æ‹·è²æ¨¡å¼: 16KB (å–®ä¸€ç·©è¡)
```

### æ€§èƒ½æå‡
```
æ›´æ–°æ™‚é–“:
- ç¸½æ™‚é–“: ~60 ç§’ (vs ~80ç§’)
  * 3 Ã— 18s = 54s (tile åˆ·æ–°)
  * 2 Ã— 3s = 6s (ç­‰å¾…æ™‚é–“)
  
- ç¯€çœæ™‚é–“: 20 ç§’ (25%)
- ç¶²è·¯å‚³è¼¸: æ¸›å°‘ 1 æ¬¡
- ç”¨æˆ¶é«”é©—: æ˜é¡¯æ”¹å–„ âœ…
```

---

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### æ¸¬è©¦æ­¥é©Ÿ
```bash
# 1. å•Ÿå‹• ESP8266 (å·²ä¸Šå‚³æ–°éŸŒé«”)
# è§€å¯Ÿ Serial Monitor å•Ÿå‹•è¨Šæ¯

# 2. å•Ÿå‹• Server
cd server
python server.py

# 3. ç™¼é€æ¸¬è©¦åœ–ç‰‡
tile test_images_800x480/tile_test_800x480.png

# 4. è§€å¯Ÿ Serial Monitor è¼¸å‡º
```

### é æœŸ Serial Log
```
ğŸ“ åˆ†å€æ›´æ–°: ä¸Šæ–¹ (ç´¢å¼•=0, åº§æ¨™=(0,0), å°ºå¯¸=800Ã—160)
âœ“ ä½¿ç”¨é å…ˆé…ç½®çš„åˆ†å€ç·©è¡å€
ğŸ” ç•¶å‰è¨˜æ†¶é«”: å¯ç”¨=7xxx bytes
âœ“ Payload ä½¿ç”¨å¤–éƒ¨ç·©è¡å€ï¼ˆé›¶æ‹·è²ï¼‰  â† æ‡‰è©²é¡¯ç¤ºé›¶æ‹·è²ï¼
âœ“ setPartialWindow å®Œæˆ
âœ“ writeImage å®Œæˆ
ğŸ”„ é–‹å§‹ refresh...
âœ“ refresh å®Œæˆ
âœ… åˆ†å€ ä¸Šæ–¹ æ›´æ–°å®Œæˆ (~18s)

[é‡è¤‡ ä¸­é–“ã€ä¸‹æ–¹]
```

### é©—è­‰é»
- [  ] âœ… 3 å€‹åˆ†å€éƒ½é¡¯ç¤ºï¼ˆä¸Šã€ä¸­ã€ä¸‹ï¼‰
- [  ] âœ… ä½ç½®æ­£ç¢ºï¼ˆæ°´å¹³æ¢ç‹€ï¼‰
- [  ] âœ… Serial log é¡¯ç¤º "âœ“ Payload ä½¿ç”¨å¤–éƒ¨ç·©è¡å€ï¼ˆé›¶æ‹·è²ï¼‰"
- [  ] âœ… è¨˜æ†¶é«”ç©©å®š (~7-8KB å¯ç”¨)
- [  ] âœ… ç¸½æ›´æ–°æ™‚é–“ ~60 ç§’
- [  ] âœ… ç„¡å´©æ½°æˆ–éŒ¯èª¤

---

## ğŸ“ æŠ€è¡“ç´°ç¯€

### é›¶æ‹·è²å·¥ä½œæµç¨‹
```
1. Setup:
   tileBuffer = malloc(16000)  // ä¸€æ¬¡æ€§é…ç½®

2. æ¥æ”¶å°åŒ…:
   setExternalBuffer(tileBuffer, 16000)
   â†’ PacketReceiver.payload = tileBuffer
   â†’ PacketReceiver.useExternalBuffer = true

3. è™•ç†è³‡æ–™:
   originalPayload = payload  // ä¿å­˜åŸå§‹æŒ‡æ¨™
   tileIndex = payload[0]     // è®€å–ç´¢å¼•
   payload++                  // è·³éç´¢å¼•
   
4. é›¶æ‹·è²æª¢æ¸¬:
   if (originalPayload == tileBuffer):  // âœ… æª¢æ¸¬æˆåŠŸ
      memmove(tileBuffer, tileBuffer + 1, length)  // ç§»é™¤ç´¢å¼•
      // ç„¡éœ€ memcpyï¼Œè³‡æ–™å·²åœ¨ tileBufferï¼

5. é¡¯ç¤º:
   writeImage(tileBuffer, tile_x, tile_y, 800, 160)
   // ç›´æ¥ä½¿ç”¨ tileBuffer

6. Reset:
   reset() ä¸æœƒ free(tileBuffer)  // å¤–éƒ¨ç·©è¡ä¿è­·
   
7. ä¸‹ä¸€å€‹ tile:
   é‡ç”¨åŒä¸€å€‹ tileBuffer
```

### è¨˜æ†¶é«”å¸ƒå±€
```
ESP8266 RAM (80KB):
â”œâ”€ ç³»çµ±ä½¿ç”¨: ~50KB
â”œâ”€ ç¨‹å¼ä½¿ç”¨: ~14KB (éœæ…‹ + å †)
â””â”€ å¯ç”¨å †: ~16KB
    â”œâ”€ tileBuffer: 16KB (é å…ˆé…ç½®)
    â””â”€ å…¶ä»–: ~0KB (ç·Šç·Šå¥½!)

æ³¨æ„: 16KB tileBuffer å¹¾ä¹ç”¨ç›¡æ‰€æœ‰å¯ç”¨å †
     ä½†é›¶æ‹·è²æ¶æ§‹ç¢ºä¿ä¸éœ€è¦é¡å¤–è¨˜æ†¶é«”
```

---

## ğŸš€ å‡ç´šæŒ‡å—

### å¾ v1.6.4 å‡ç´š

1. **Pull æœ€æ–°ä»£ç¢¼**
   ```bash
   git pull origin main
   ```

2. **ç·¨è­¯ä¸¦ä¸Šå‚³**
   ```bash
   cd client_esp8266
   arduino-cli compile --fqbn esp8266:esp8266:d1_mini .
   arduino-cli upload -p COM5 --fqbn esp8266:esp8266:d1_mini .
   ```

3. **é‡å•Ÿ ESP8266**
   - ç­‰å¾…é€£æ¥åˆ° WiFi
   - Serial Monitor é¡¯ç¤º "é…ç½®åˆ†å€ç·©è¡å€ (16KB)"

4. **æ¸¬è©¦**
   ```bash
   cd ../server
   python server.py
   # åœ¨ server æ§åˆ¶å°è¼¸å…¥:
   tile your_image.png
   ```

### Breaking Changes
- âš ï¸ **åˆ†å€æ•¸é‡è®Šæ›´**: 4 â†’ 3
- âš ï¸ **åˆ†å€å°ºå¯¸è®Šæ›´**: 400Ã—240 â†’ 800Ã—160
- âš ï¸ **åˆ†å€æ’åˆ—è®Šæ›´**: 2Ã—2ç¶²æ ¼ â†’ æ°´å¹³æ¢ç‹€
- âœ… **å‘å¾Œå…¼å®¹**: Server å’Œ Client å¿…é ˆåŒæ™‚æ›´æ–°

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **è¨­è¨ˆæ–‡æª”**: `TILED_DISPLAY_DESIGN.md`
- **ä½¿ç”¨æŒ‡å—**: `TILED_DISPLAY_USAGE.md`
- **v1.6.4 ç™¼å¸ƒ**: `RELEASE_NOTES_V1.6.4.md`
- **v1.6.3 ä¿®å¾©**: `BUGFIX_V1.6.3_CRITICAL.md`
- **v1.6.4 ä¿®å¾©**: `COORDINATE_FIX_V1.6.4.md`

---

## âœ… å¯¦æ–½ç‹€æ…‹

- [x] ESP8266 é…ç½®æ›´æ–° (config.h, protocol.h)
- [x] é›¶æ‹·è²å•é¡Œä¿®å¾© (originalPayload)
- [x] åº§æ¨™è¨ˆç®—æ›´æ–° (æ°´å¹³åˆ†å‰²)
- [x] Server ç«¯åœ–åƒåˆ†å‰²æ›´æ–°
- [x] Server ç«¯ log è¨Šæ¯æ›´æ–°
- [x] ç·¨è­¯æˆåŠŸ (ç„¡è­¦å‘Š)
- [x] ä¸Šå‚³æˆåŠŸ (COM5)
- [ ] ç¡¬é«”æ¸¬è©¦ (å¾…åŸ·è¡Œ)

---

## ğŸ¯ é æœŸçµæœ

**æ–¹æ¡ˆ A æˆåŠŸå¾Œ**:
- âœ… é¡¯ç¤ºæ™‚é–“æ¸›å°‘ 25% (80s â†’ 60s)
- âœ… å‚³è¼¸æ¬¡æ•¸æ¸›å°‘ 25% (4 â†’ 3)
- âœ… é›¶æ‹·è²çœŸæ­£ç”Ÿæ•ˆ (ç„¡ä¸å¿…è¦çš„ memcpy)
- âœ… è¨˜æ†¶é«”ä½¿ç”¨å„ªåŒ– (16KB vs 12KB, ä½†æ›´å°‘çš„æ¬¡æ•¸)
- âœ… ç”¨æˆ¶é«”é©—æ”¹å–„ (æ›´å¿«çš„æ›´æ–°)

---

**Status**: âœ… å¯¦æ–½å®Œæˆï¼Œç­‰å¾…æ¸¬è©¦é©—è­‰  
**Next**: åŸ·è¡Œç¡¬é«”æ¸¬è©¦ä¸¦é©—è­‰æ‰€æœ‰åŠŸèƒ½
