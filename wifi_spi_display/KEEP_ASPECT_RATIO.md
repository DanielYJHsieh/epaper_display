# 保持比例功能說明

## 🎯 問題描述

**修改前**：
- 點擊「重設選區」會選取整張圖片
- 傳送時會拉伸填滿 800×480，導致圖片變形

**修改後**：
- 點擊「重設選區」會自動計算最佳裁切區域（保持 800×480 或 480×800 比例）
- 傳送時保持原始比例，不足部分用**白色背景**填充
- 避免圖片變形

---

## 📊 工作原理

### 1. 重設選區（`resetCrop()`）

**橫向模式 (800×480)**：
```javascript
圖片寬高比 vs 顯示比例 (800/480 = 1.667)

Case 1: 圖片更寬 (ratio > 1.667)
  例如：1920×1080 (ratio = 1.778)
  → 選區高度 = 圖片高度 (1080)
  → 選區寬度 = 1080 × 1.667 = 1800
  → 居中選取

Case 2: 圖片更高 (ratio < 1.667)
  例如：1080×1920 (ratio = 0.563)
  → 選區寬度 = 圖片寬度 (1080)
  → 選區高度 = 1080 ÷ 1.667 = 648
  → 從頂部選取
```

### 2. 傳送圖片（`sendImage()`）

**橫向模式處理**：
```javascript
1. 創建 800×480 canvas
2. 填充白色背景
3. 計算裁切區域比例
4. 比較裁切比例和顯示比例

Case A: 比例相同 (誤差 < 1%)
  → 直接填滿 800×480

Case B: 裁切區域更寬
  → 以寬度為準 (800px)
  → 高度按比例計算
  → 上下留白 (居中)

Case C: 裁切區域更高
  → 以高度為準 (480px)
  → 寬度按比例計算
  → 左右留白 (居中)
```

**直向模式處理**：
```javascript
1. 創建 800×480 canvas
2. 填充白色背景
3. 計算旋轉後的比例 (height/width，因為旋轉 90°)
4. 按比例繪製並居中
5. 旋轉 90° 順時針
6. 結果：圖片保持比例，空白處為白色
```

---

## 🖼️ 範例場景

### 場景 1：方形圖片 (1000×1000)

**橫向模式**：
```
原始: 1000×1000 (ratio = 1.0)
顯示: 800×480 (ratio = 1.667)

重設選區:
- 選區寬度 = 1000
- 選區高度 = 1000 ÷ 1.667 = 600 (超出圖片高度)
- 實際選區高度 = 1000
- 實際選區寬度 = 1000 × 1.667 = 1667 (超出圖片寬度)
- 最終: 選取整張圖片 1000×1000

傳送處理:
- 裁切比例 = 1.0
- 顯示比例 = 1.667
- 裁切更高，以高度為準
- 繪製高度 = 480px
- 繪製寬度 = 480 × 1.0 = 480px
- 左右留白 = (800 - 480) ÷ 2 = 160px

結果:
┌────────────────────────────────┐
│        白色    │圖片│  白色      │  800px
│        (160px) │480│ (160px)    │
│                │ ×  │            │
│                │480 │            │
│                │px  │            │
└────────────────────────────────┘
                480px
```

### 場景 2：寬圖 (1920×1080)

**橫向模式**：
```
原始: 1920×1080 (ratio = 1.778)
顯示: 800×480 (ratio = 1.667)

重設選區:
- 圖片更寬 (1.778 > 1.667)
- 選區高度 = 1080
- 選區寬度 = 1080 × 1.667 = 1800
- 選區位置 = ((1920-1800)/2, 0) = (60, 0)

傳送處理:
- 裁切比例 = 1800/1080 = 1.667
- 顯示比例 = 1.667
- 比例相同！直接填滿

結果:
┌────────────────────────────────┐
│                                │
│          圖片填滿整個畫面        │  800×480
│          無留白                 │
│                                │
└────────────────────────────────┘
```

### 場景 3：直向圖片 (1080×1920)

**橫向模式**：
```
原始: 1080×1920 (ratio = 0.563)
顯示: 800×480 (ratio = 1.667)

重設選區:
- 圖片更高 (0.563 < 1.667)
- 選區寬度 = 1080
- 選區高度 = 1080 ÷ 1.667 = 648
- 選區位置 = (0, 0)

傳送處理:
- 裁切比例 = 1080/648 = 1.667
- 顯示比例 = 1.667
- 比例相同！直接填滿

結果:
┌────────────────────────────────┐
│                                │
│          圖片填滿整個畫面        │  800×480
│          (裁切中間部分)         │
│                                │
└────────────────────────────────┘
```

**直向模式 (切換後)**：
```
顯示: 480×800 (ratio = 0.6)
旋轉後: 800×480

重設選區:
- 選區寬度 = 1080
- 選區高度 = 1080 × 0.6 = 648

傳送處理:
- 旋轉 90° 後比例 = 648/1080 = 0.6
- 顯示比例 (旋轉後) = 800/480 = 1.667
- 裁切更高，以高度為準
- 繪製 480×800，旋轉後變成 800×480，居中

結果:
上下留白
```

---

## 🎨 視覺效果

### 橫向模式 - 方形圖片
```
┌───────────────────────────────────┐
│ ░░░░░░░ ┌────────┐ ░░░░░░░       │
│ ░WHITE░ │        │ ░WHITE░       │
│ ░SPACE░ │  圖片  │ ░SPACE░       │ 480px
│ ░░░░░░░ │  保持  │ ░░░░░░░       │
│ ░░░░░░░ │  比例  │ ░░░░░░░       │
│ ░░░░░░░ └────────┘ ░░░░░░░       │
└───────────────────────────────────┘
         800px
```

### 橫向模式 - 寬圖
```
┌───────────────────────────────────┐
│                                   │
│        圖片填滿整個畫面            │
│        (800×480)                  │
│        無變形                     │
│                                   │
└───────────────────────────────────┘
```

### 直向模式 - 直向圖片
```
┌───────────────────────────────────┐
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   │
│ ░ WHITE SPACE (上方留白) ░        │
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   │
│ ┌─────────────────────────────┐   │
│ │                             │   │
│ │    圖片 (旋轉 90° 後)       │   │
│ │    保持比例                 │   │
│ │                             │   │
│ └─────────────────────────────┘   │
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   │
│ ░ WHITE SPACE (下方留白) ░        │
│ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   │
└───────────────────────────────────┘
         800px
```

---

## 🔧 技術細節

### 修改的函數

**1. `resetCrop()` 函數**：
```javascript
function resetCrop() {
    if (!sourceImage) return;
    
    const displayRatio = getDisplayRatio();  // 800/480 或 480/800
    const imgRatio = sourceImage.width / sourceImage.height;
    
    if (imgRatio > displayRatio) {
        // 圖片更寬
        cropRect = {
            x: 0,
            y: 0,
            width: sourceImage.width,
            height: sourceImage.width / displayRatio
        };
    } else {
        // 圖片更高
        cropRect = {
            x: 0,
            y: 0,
            width: sourceImage.height * displayRatio,
            height: sourceImage.height
        };
    }
    
    drawCrop();
    showAlert('✅ 已重設選區（保持比例）', 'success');
}
```

**2. `sendImage()` 函數 - 橫向模式**：
```javascript
// 填充白色背景
cropCtx.fillStyle = 'white';
cropCtx.fillRect(0, 0, size.width, size.height);

// 計算比例
const cropRatio = cropRect.width / cropRect.height;
const displayRatio = size.width / size.height;

// 按比例繪製，居中
if (cropRatio > displayRatio) {
    // 更寬，上下留白
    drawWidth = size.width;
    drawHeight = size.width / cropRatio;
    drawY = (size.height - drawHeight) / 2;
} else {
    // 更高，左右留白
    drawHeight = size.height;
    drawWidth = size.height * cropRatio;
    drawX = (size.width - drawWidth) / 2;
}
```

**3. `sendImage()` 函數 - 直向模式**：
```javascript
// 填充白色背景
cropCtx.fillStyle = 'white';
cropCtx.fillRect(0, 0, DISPLAY_WIDTH, DISPLAY_HEIGHT);

// 旋轉後的比例計算
const cropRatio = cropRect.height / cropRect.width;

// 按比例計算繪製尺寸
if (cropRatio > displayRatio) {
    drawWidth = DISPLAY_HEIGHT;
    drawHeight = DISPLAY_HEIGHT / cropRatio;
} else {
    drawHeight = DISPLAY_WIDTH;
    drawWidth = DISPLAY_WIDTH * cropRatio;
}

// 旋轉並居中繪製
cropCtx.translate(DISPLAY_WIDTH / 2, DISPLAY_HEIGHT / 2);
cropCtx.rotate(90 * Math.PI / 180);
cropCtx.drawImage(..., -drawWidth/2, -drawHeight/2, drawWidth, drawHeight);
```

---

## ✅ 優點

1. **保持比例**: 圖片不會變形拉伸
2. **自動居中**: 空白區域平均分配
3. **白色背景**: 適合電子紙顯示（省電）
4. **智能裁切**: 重設時自動選擇最佳區域
5. **兩種模式**: 橫向和直向都支援

---

## 📝 使用建議

### 最佳實踐

1. **橫向圖片** (16:9, 4:3)：
   - 使用橫向模式 (800×480)
   - 點擊「重設選區」會自動選擇中央區域
   - 傳送時會填滿或居中顯示

2. **直向圖片** (9:16, 3:4)：
   - 切換到直向模式 (480×800)
   - 點擊「重設選區」會自動選擇上方區域
   - 傳送時會旋轉 90° 並居中

3. **方形圖片** (1:1)：
   - 橫向模式：左右留白
   - 直向模式：上下留白（旋轉後）

### 手動調整

如果自動選區不滿意：
1. 點擊「重設選區」獲得預設選區
2. 拖曳調整選區位置和大小
3. 使用「自動適配」鎖定 800×480 或 480×800 比例

---

## 🐛 故障排除

### 問題：圖片仍然變形

**檢查**：
- 是否使用了「自動適配」而非「重設選區」？
- 「自動適配」會裁切並填滿，可能看起來像拉伸

**解決**：
- 使用「重設選區」按鈕
- 手動調整選區到想要的部分

### 問題：空白區域太大

**原因**：
- 原始圖片比例與顯示器差異太大

**解決**：
- 切換方向試試（橫向 ↔ 直向）
- 或使用「自動適配」裁切填滿

---

## 📊 比較表

| 功能 | 修改前 | 修改後 |
|------|--------|--------|
| 重設選區 | 選取整張圖片 | 選取最佳比例區域 |
| 傳送處理 | 拉伸填滿 800×480 | 保持比例，空白填充 |
| 圖片變形 | ❌ 可能變形 | ✅ 不會變形 |
| 空白處理 | N/A | ✅ 白色背景居中 |
| 直向支援 | ❌ 會拉伸 | ✅ 旋轉後保持比例 |

---

## 📅 更新資訊

- **修改日期**: 2025-10-10
- **版本**: v1.8.1
- **修改檔案**: `server/server_with_webui.py`
- **影響功能**: 重設選區、圖片傳送

---

**完成！現在「重設選區」會保持圖片比例，不會變形了！** 🎉
